
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Contextualized Knowledge Graph Embedding &#8212; graph-embeddings</title>
    
  <link href="_static/css/theme.css" rel="stylesheet" />
  <link href="_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="_static/js/index.1c5a1a01449ed65a7b51.js">

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/togglebutton.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script>
        const thebe_selector = ".thebe,.cell"
        const thebe_selector_input = "pre,.cell_input div.highlight"
        const thebe_selector_output = ".output,.cell_output"
    </script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="SPLITTER: Learning Node Representations from Multiple Contexts" href="T643979_Learning_Node_Representations_from_Multiple_Social_Contexts.html" />
    <link rel="prev" title="KHGT knowledge graph embeddings" href="T457098_KHGT_knowledge_graph_embeddings.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="index.html">
      
      
      
      <h1 class="site-logo" id="site-title">graph-embeddings</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="US549467_Graph_embeddings.html">
   Graph embeddings
  </a>
 </li>
</ul>
<p class="caption" role="heading">
 <span class="caption-text">
  Concepts
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="L742313_Key_developments.html">
   Key developments
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="L991141_Random_walk.html">
   Random walk
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="L128493_Skip_gram_model.html">
   Skip-gram model
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="L883045_Message_Passing_Neural_Networks.html">
   Message Passing Neural Networks
  </a>
 </li>
</ul>
<p class="caption" role="heading">
 <span class="caption-text">
  Models
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="C870584_DeepWalk.html">
   DeepWalk
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="C067906_LINE.html">
   LINE
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="C662128_SDNE.html">
   SDNE
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="C039027_Node2vec.html">
   Node2vec
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="C694808_Struc2Vec.html">
   Struc2Vec
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="C779816_Splitter.html">
   Splitter
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="C652166_CoKE.html">
   CoKE
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="C047239_GAT.html">
   GAT
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="C110059_GATv2.html">
   GATv2
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="C538124_BigGraph.html">
   BigGraph
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="C503513_KHGT.html">
   KHGT
  </a>
 </li>
</ul>
<p class="caption" role="heading">
 <span class="caption-text">
  Tutorials
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="T050508_Introduction_to_Networkx.html">
   Introduction to Networkx
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T528562_Graph_properties.html">
   Graph properties
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T118630_Graph_Benchmarks.html">
   Graph Benchmarks
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T984528_Graph_encoder.html">
   Graph encoder
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T384270_DeepWalk_in_python.html">
   DeepWalk in python
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T382881_DeepWalk_on_Karateclub.html">
   DeepWalk on Karateclub
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T677598_DeepWalk_on_ML_100k.html">
   DeepWalk on ML-100k
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T862985_LINE_on_Wiki_network.html">
   LINE on Wiki network
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T186367_Node2vec_from_scratch.html">
   Node2vec from scratch
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T611050_Node2vec_in_PyTorch_Geometric_on_CORA_dataset.html">
   Node2vec in PyTorch Geometric on CORA dataset
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T815556_Node2vec_on_Karateclub.html">
   Node2vec on Karateclub
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T894941_Node2vec_on_ML_latest_in_Keras.html">
   Node2vec on ML-latest in Keras
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T926278_Node2vec_Edge2vec_and_Graph2vec.html">
   Node2vec, Edge2vec, and Graph2vec
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T401127_GEM_on_Karateclub.html">
   GEM on Karateclub
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T481518_Struc2vec_on_airports_graph.html">
   Struc2vec on airports graph
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T516490_Learn_embeddings_using_Graph_Networks.html">
   Learn Embeddings using Graph Networks
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T981902_Shallow_embedding_methods.html">
   Shallow embedding methods
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T189677_Graph_embeddings_using_SDNE.html">
   Graph embeddings using SDNE
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T873032_Graph_embeddings_using_Convnet_Stellargraph.html">
   Graph embeddings using Convnet Stellargraph
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T674201_Graph_embeddings.html">
   Graph ML Embeddings
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T457098_KHGT_knowledge_graph_embeddings.html">
   KHGT knowledge graph embeddings
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Contextualized Knowledge Graph Embedding
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T643979_Learning_Node_Representations_from_Multiple_Social_Contexts.html">
   SPLITTER: Learning Node Representations from Multiple Contexts
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T874868_GAT_in_Tensorflow.x.html">
   GAT using Tensorflow
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T249662_GAT_in_PyTorch_on_CORA.html">
   GAT in PyTorch on CORA
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T336765_FB15K_Graph_Embedding_Learning_in_PyTorch_Big_Graph.html">
   FB15K Graph Embedding Learning in PyTorch Big Graph
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T012114_SAGEConv_graph_embeddings_in_PyG.html">
   SAGEConv graph embeddings in PyG
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="_sources/T403235_Contextualized_Knowledge_Graph_Embedding.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/sparsh-ai/graph-embeddings/main?urlpath=lab/tree/docs/T403235_Contextualized_Knowledge_Graph_Embedding.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        <a class="colab-button" href="https://colab.research.google.com/github/sparsh-ai/graph-embeddings/blob/main/docs/T403235_Contextualized_Knowledge_Graph_Embedding.ipynb"><button type="button" class="btn btn-secondary topbarbtn"
                title="Launch Colab" data-toggle="tooltip" data-placement="left"><img class="colab-button-logo"
                    src="_static/images/logo_colab.png"
                    alt="Interact on Colab">Colab</button></a>
        
        <button type="button" class="btn btn-secondary topbarbtn"
            onclick="initThebeSBT()" title="Launch Thebe" data-toggle="tooltip" data-placement="left"><i
                class="fas fa-play"></i><span style="margin-left: .4em;">Live Code</span></button>
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="contextualized-knowledge-graph-embedding">
<h1>Contextualized Knowledge Graph Embedding<a class="headerlink" href="#contextualized-knowledge-graph-embedding" title="Permalink to this headline">¶</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>!apt-get -qq install tree
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>%%writefile wget_dataset.sh
#!/bin/bash
mkdir data
cd data
##downloads the 4 widely used KBC dataset
wget -q --show-progress --no-check-certificate https://everest.hds.utc.fr/lib/exe/fetch.php?media=en:fb15k.tgz -O fb15k.tgz
wget -q --show-progress --no-check-certificate https://everest.hds.utc.fr/lib/exe/fetch.php?media=en:wordnet-mlj12.tar.gz -O wordnet-mlj12.tar.gz
wget -q --show-progress --no-check-certificat https://download.microsoft.com/download/8/7/0/8700516A-AB3D-4850-B4BB-805C515AECE1/FB15K-237.2.zip -O FB15K-237.2.zip
wget -q --show-progress --no-check-certificat https://raw.githubusercontent.com/TimDettmers/ConvE/master/WN18RR.tar.gz -O WN18RR.tar.gz 

##downloads the path query dataset
wget -q --show-progress --no-check-certificate https://worksheets.codalab.org/rest/bundles/0xdb6b691c2907435b974850e8eb9a5fc2/contents/blob/ -O freebase_paths.tar.gz
wget -q --show-progress --no-check-certificate https://worksheets.codalab.org/rest/bundles/0xf91669f6c6d74987808aeb79bf716bd0/contents/blob/ -O wordnet_paths.tar.gz

## organize the train/valid/test files by renaming
#fb15k
tar -xvf fb15k.tgz 
mv FB15k fb15k
mv ./fb15k/freebase_mtr100_mte100-train.txt ./fb15k/train.txt
mv ./fb15k/freebase_mtr100_mte100-test.txt ./fb15k/test.txt
mv ./fb15k/freebase_mtr100_mte100-valid.txt ./fb15k/valid.txt

#wn18
tar -zxvf wordnet-mlj12.tar.gz &amp;&amp; mv wordnet-mlj12 wn18
mv wn18/wordnet-mlj12-train.txt wn18/train.txt
mv wn18/wordnet-mlj12-test.txt wn18/test.txt
mv wn18/wordnet-mlj12-valid.txt wn18/valid.txt


#fb15k237
unzip FB15K-237.2.zip &amp;&amp; mv Release fb15k237

#wn18rr
mkdir wn18rr &amp;&amp; tar -zxvf WN18RR.tar.gz -C wn18rr

#pathqueryWN
mkdir pathqueryWN &amp;&amp; tar -zxvf wordnet_paths.tar.gz -C pathqueryWN

#pathqueryFB
mkdir pathqueryFB &amp;&amp; tar -zxvf freebase_paths.tar.gz -C pathqueryFB

##rm tmp zip files
rm ./*.gz
rm ./*.tgz
rm ./*.zip
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Overwriting wget_dataset.sh
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>!sh wget_dataset.sh
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>mkdir: cannot create directory ‘data’: File exists
wget_dataset.sh: 4: wget_dataset.sh: pushd: not found
fb15k.tgz           100%[===================&gt;]   7.31M  6.45MB/s    in 1.1s    
wordnet-mlj12.tar.g 100%[===================&gt;]   3.14M  3.64MB/s    in 0.9s    
FB15K-237.2.zip     100%[===================&gt;] 139.45M  17.2MB/s    in 8.0s    
WN18RR.tar.gz       100%[===================&gt;] 871.93K  --.-KB/s    in 0.03s   
freebase_paths.tar.     [          &lt;=&gt;       ] 118.39M  6.33MB/s    in 19s     
wordnet_paths.tar.g     [ &lt;=&gt;                ]  36.34M  4.99MB/s    in 7.2s    
FB15k/
FB15k/freebase_mtr100_mte100-test.txt
FB15k/freebase_mtr100_mte100-train.txt
FB15k/freebase_mtr100_mte100-valid.txt
FB15k/README
./._wordnet-mlj12
wordnet-mlj12/
wordnet-mlj12/README
wordnet-mlj12/._wordnet-mlj12-definitions.txt
wordnet-mlj12/wordnet-mlj12-definitions.txt
wordnet-mlj12/._wordnet-mlj12-test.txt
wordnet-mlj12/wordnet-mlj12-test.txt
wordnet-mlj12/._wordnet-mlj12-train.txt
wordnet-mlj12/wordnet-mlj12-train.txt
wordnet-mlj12/._wordnet-mlj12-valid.txt
wordnet-mlj12/wordnet-mlj12-valid.txt
wordnet-mlj12/Wordnet3.0-LICENSE
Archive:  FB15K-237.2.zip
  inflating: Release/MSR-LA_Data_Full Rights_FB15K-237 Knowledge Base Completion Dataset (2650).docx  
  inflating: Release/README.txt      
  inflating: Release/test.txt        
  inflating: Release/text_cvsc.txt   
  inflating: Release/text_emnlp.txt  
  inflating: Release/train.txt       
  inflating: Release/valid.txt       
valid.txt
train.txt
test.txt
./
./test_approx
./test_gen
./train
./dev_approx
./dev
./test
./dev_gen
./
./test_approx
./test_gen
./train
./dev_approx
./dev
./test
./dev_gen
wget_dataset.sh: 47: wget_dataset.sh: popd: not found
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>!tree /content/data
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/content/data
├── fb15k
│   ├── README
│   ├── test.txt
│   ├── train.txt
│   └── valid.txt
├── fb15k237
│   ├── MSR-LA_Data_Full Rights_FB15K-237 Knowledge Base Completion Dataset (2650).docx
│   ├── README.txt
│   ├── test.txt
│   ├── text_cvsc.txt
│   ├── text_emnlp.txt
│   ├── train.txt
│   └── valid.txt
├── pathqueryFB
│   ├── dev
│   ├── dev_approx
│   ├── dev_gen
│   ├── test
│   ├── test_approx
│   ├── test_gen
│   └── train
├── pathqueryWN
│   ├── dev
│   ├── dev_approx
│   ├── dev_gen
│   ├── test
│   ├── test_approx
│   ├── test_gen
│   └── train
├── wn18
│   ├── README
│   ├── test.txt
│   ├── train.txt
│   ├── valid.txt
│   ├── Wordnet3.0-LICENSE
│   └── wordnet-mlj12-definitions.txt
└── wn18rr
    ├── test.txt
    ├── train.txt
    └── valid.txt

6 directories, 34 files
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Attention! Python 2.7.14  and python3 gives different vocabulary order. We use Python 2.7.14 to preprocess files.</span>

<span class="c1"># input files: train.txt valid.txt test.txt  </span>
<span class="c1"># (these are default filenames, change files name with the following arguments:  --train $trainname --valid $validname --test $testname)</span>
<span class="c1"># output files: vocab.txt train.coke.txt valid.coke.txt test.coke.txt</span>
<span class="n">python</span> <span class="o">./</span><span class="nb">bin</span><span class="o">/</span><span class="n">kbc_data_preprocess</span><span class="o">.</span><span class="n">py</span> <span class="o">--</span><span class="n">task</span> <span class="n">fb15k</span> <span class="o">--</span><span class="nb">dir</span> <span class="o">./</span><span class="n">data</span><span class="o">/</span><span class="n">fb15k</span>
<span class="n">python</span> <span class="o">./</span><span class="nb">bin</span><span class="o">/</span><span class="n">kbc_data_preprocess</span><span class="o">.</span><span class="n">py</span> <span class="o">--</span><span class="n">task</span> <span class="n">wn18</span> <span class="o">--</span><span class="nb">dir</span> <span class="o">./</span><span class="n">data</span><span class="o">/</span><span class="n">wn18</span>
<span class="n">python</span> <span class="o">./</span><span class="nb">bin</span><span class="o">/</span><span class="n">kbc_data_preprocess</span><span class="o">.</span><span class="n">py</span> <span class="o">--</span><span class="n">task</span> <span class="n">fb15k237</span> <span class="o">--</span><span class="nb">dir</span> <span class="o">./</span><span class="n">data</span><span class="o">/</span><span class="n">fb15k237</span>
<span class="n">python</span> <span class="o">./</span><span class="nb">bin</span><span class="o">/</span><span class="n">kbc_data_preprocess</span><span class="o">.</span><span class="n">py</span> <span class="o">--</span><span class="n">task</span> <span class="n">wn18rr</span> <span class="o">--</span><span class="nb">dir</span> <span class="o">./</span><span class="n">data</span><span class="o">/</span><span class="n">wn18rr</span>

<span class="c1"># input files: train dev test</span>
<span class="c1"># (these are default filenames, change files name with the following arguments: --train $trainname --valid $validname --test $testname)</span>
<span class="c1"># output files: vocab.txt train.coke.txt valid.coke.txt test.coke.txt sen_candli.txt trivial_sen.txt</span>
<span class="n">python</span> <span class="o">./</span><span class="nb">bin</span><span class="o">/</span><span class="n">pathquery_data_preprocess</span><span class="o">.</span><span class="n">py</span> <span class="o">--</span><span class="n">task</span> <span class="n">pathqueryFB</span> <span class="o">--</span><span class="nb">dir</span> <span class="o">./</span><span class="n">data</span><span class="o">/</span><span class="n">pathqueryFB</span> 
<span class="n">python</span> <span class="o">./</span><span class="nb">bin</span><span class="o">/</span><span class="n">pathquery_data_preprocess</span><span class="o">.</span><span class="n">py</span> <span class="o">--</span><span class="n">task</span> <span class="n">pathqueryWN</span> <span class="o">--</span><span class="nb">dir</span> <span class="o">./</span><span class="n">data</span><span class="o">/</span><span class="n">pathqueryWN</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">data preprocess for KBC datasets</span>
<span class="sd">&quot;&quot;&quot;</span>


<span class="k">def</span> <span class="nf">get_unique_entities_relations</span><span class="p">(</span><span class="n">train_file</span><span class="p">,</span> <span class="n">dev_file</span><span class="p">,</span> <span class="n">test_file</span><span class="p">):</span>
    <span class="n">entity_lst</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">relation_lst</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">all_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">train_file</span><span class="p">,</span> <span class="n">dev_file</span><span class="p">,</span> <span class="n">test_file</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">input_file</span> <span class="ow">in</span> <span class="n">all_files</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;dealing </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">train_file</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">input_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
                <span class="n">tokens</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span>
                <span class="n">entity_lst</span><span class="p">[</span><span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">entity_lst</span><span class="p">)</span>
                <span class="n">entity_lst</span><span class="p">[</span><span class="n">tokens</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">entity_lst</span><span class="p">)</span>
                <span class="n">relation_lst</span><span class="p">[</span><span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">relation_lst</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&gt;&gt; Number of unique entities: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">entity_lst</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&gt;&gt; Number of unique relations: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">relation_lst</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">entity_lst</span><span class="p">,</span> <span class="n">relation_lst</span>


<span class="k">def</span> <span class="nf">write_vocab</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">entity_lst</span><span class="p">,</span> <span class="n">relation_lst</span><span class="p">):</span>
    <span class="n">fout</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
    <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;[PAD]&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">95</span><span class="p">):</span>
        <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;[unused</span><span class="si">{}</span><span class="s2">]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
    <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;[UNK]&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;[CLS]&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;[SEP]&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;[MASK]&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">entity_lst</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">e</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">relation_lst</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">vocab_size</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">entity_lst</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">relation_lst</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&gt;&gt; vocab_size: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">vocab_size</span><span class="p">)</span>
    <span class="n">fout</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">load_vocab</span><span class="p">(</span><span class="n">vocab_file</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Loads a vocabulary file into a dictionary.&quot;&quot;&quot;</span>
    <span class="n">vocab</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
    <span class="n">fin</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">vocab_file</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">num</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fin</span><span class="p">):</span>
        <span class="n">items</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">items</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">else</span> <span class="n">num</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">vocab</span><span class="p">[</span><span class="n">token</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">vocab</span>


<span class="k">def</span> <span class="nf">write_true_triples</span><span class="p">(</span><span class="n">train_file</span><span class="p">,</span> <span class="n">dev_file</span><span class="p">,</span> <span class="n">test_file</span><span class="p">,</span> <span class="n">vocab</span><span class="p">,</span> <span class="n">output_file</span><span class="p">):</span>
    <span class="n">true_triples</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">all_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">train_file</span><span class="p">,</span> <span class="n">dev_file</span><span class="p">,</span> <span class="n">test_file</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">input_file</span> <span class="ow">in</span> <span class="n">all_files</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">input_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
                <span class="n">h</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1"> </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">assert</span> <span class="p">(</span><span class="n">h</span> <span class="ow">in</span> <span class="n">vocab</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">r</span> <span class="ow">in</span> <span class="n">vocab</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">t</span> <span class="ow">in</span> <span class="n">vocab</span><span class="p">)</span>
                <span class="n">hpos</span> <span class="o">=</span> <span class="n">vocab</span><span class="p">[</span><span class="n">h</span><span class="p">]</span>
                <span class="n">rpos</span> <span class="o">=</span> <span class="n">vocab</span><span class="p">[</span><span class="n">r</span><span class="p">]</span>
                <span class="n">tpos</span> <span class="o">=</span> <span class="n">vocab</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
                <span class="n">true_triples</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">hpos</span><span class="p">,</span> <span class="n">rpos</span><span class="p">,</span> <span class="n">tpos</span><span class="p">))</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&gt;&gt; Number of true triples: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">true_triples</span><span class="p">))</span>
    <span class="n">fout</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">hpos</span><span class="p">,</span> <span class="n">rpos</span><span class="p">,</span> <span class="n">tpos</span> <span class="ow">in</span> <span class="n">true_triples</span><span class="p">:</span>
        <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">hpos</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">rpos</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">tpos</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">fout</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">generate_mask_type</span><span class="p">(</span><span class="n">input_file</span><span class="p">,</span> <span class="n">output_file</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fw</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">input_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fr</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fr</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
                <span class="n">fw</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1"> </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">MASK_HEAD</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">fw</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1"> </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">MASK_TAIL</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">kbc_data_preprocess</span><span class="p">(</span><span class="n">train_file</span><span class="p">,</span> <span class="n">dev_file</span><span class="p">,</span> <span class="n">test_file</span><span class="p">,</span> <span class="n">vocab_path</span><span class="p">,</span>
                        <span class="n">true_triple_path</span><span class="p">,</span> <span class="n">new_train_file</span><span class="p">,</span> <span class="n">new_dev_file</span><span class="p">,</span>
                        <span class="n">new_test_file</span><span class="p">):</span>
    <span class="n">entity_lst</span><span class="p">,</span> <span class="n">relation_lst</span> <span class="o">=</span> <span class="n">get_unique_entities_relations</span><span class="p">(</span>
        <span class="n">train_file</span><span class="p">,</span> <span class="n">dev_file</span><span class="p">,</span> <span class="n">test_file</span><span class="p">)</span>
    <span class="n">write_vocab</span><span class="p">(</span><span class="n">vocab_path</span><span class="p">,</span> <span class="n">entity_lst</span><span class="p">,</span> <span class="n">relation_lst</span><span class="p">)</span>
    <span class="n">vocab</span> <span class="o">=</span> <span class="n">load_vocab</span><span class="p">(</span><span class="n">vocab_path</span><span class="p">)</span>
    <span class="n">write_true_triples</span><span class="p">(</span><span class="n">train_file</span><span class="p">,</span> <span class="n">dev_file</span><span class="p">,</span> <span class="n">test_file</span><span class="p">,</span> <span class="n">vocab</span><span class="p">,</span>
                       <span class="n">true_triple_path</span><span class="p">)</span>

    <span class="n">generate_mask_type</span><span class="p">(</span><span class="n">train_file</span><span class="p">,</span> <span class="n">new_train_file</span><span class="p">)</span>
    <span class="n">generate_mask_type</span><span class="p">(</span><span class="n">dev_file</span><span class="p">,</span> <span class="n">new_dev_file</span><span class="p">)</span>
    <span class="n">generate_mask_type</span><span class="p">(</span><span class="n">test_file</span><span class="p">,</span> <span class="n">new_test_file</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TASK_NAME</span> <span class="o">=</span> <span class="s1">&#39;fb15k&#39;</span>
<span class="n">TASK_DATA_PATH</span> <span class="o">=</span> <span class="s1">&#39;/content/data/fb15k&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_args</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--task&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">TASK_NAME</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;task name: fb15k, fb15k237, wn18rr, wn18, pathqueryFB, pathqueryWN&quot;</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--dir&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">TASK_DATA_PATH</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;task data directory&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--train&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;train.txt&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;train file name, default train.txt&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--valid&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;valid.txt&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;valid file name, default valid.txt&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--test&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;test.txt&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;test file name, default test.txt&quot;</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="p">{})</span>
    <span class="k">return</span> <span class="n">args</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">args</span> <span class="o">=</span> <span class="n">get_args</span><span class="p">()</span>
<span class="n">task</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
<span class="k">assert</span> <span class="n">task</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;fb15k&quot;</span><span class="p">,</span> <span class="s2">&quot;wn18&quot;</span><span class="p">,</span> <span class="s2">&quot;fb15k237&quot;</span><span class="p">,</span> <span class="s2">&quot;wn18rr&quot;</span><span class="p">]</span>

<span class="n">raw_train_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">dir</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">train</span><span class="p">)</span>
<span class="n">raw_dev_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">dir</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">valid</span><span class="p">)</span>
<span class="n">raw_test_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">dir</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">test</span><span class="p">)</span>

<span class="n">vocab_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">dir</span><span class="p">,</span> <span class="s2">&quot;vocab.txt&quot;</span><span class="p">)</span>
<span class="n">true_triple_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">dir</span><span class="p">,</span> <span class="s2">&quot;all.txt&quot;</span><span class="p">)</span>
<span class="n">new_train_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">dir</span><span class="p">,</span> <span class="s2">&quot;train.coke.txt&quot;</span><span class="p">)</span>
<span class="n">new_test_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">dir</span><span class="p">,</span> <span class="s2">&quot;test.coke.txt&quot;</span><span class="p">)</span>
<span class="n">new_dev_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">dir</span><span class="p">,</span> <span class="s2">&quot;valid.coke.txt&quot;</span><span class="p">)</span>

<span class="n">kbc_data_preprocess</span><span class="p">(</span><span class="n">raw_train_file</span><span class="p">,</span> <span class="n">raw_dev_file</span><span class="p">,</span> <span class="n">raw_test_file</span><span class="p">,</span>
                    <span class="n">vocab_file</span><span class="p">,</span> <span class="n">true_triple_file</span><span class="p">,</span> <span class="n">new_train_file</span><span class="p">,</span>
                    <span class="n">new_dev_file</span><span class="p">,</span> <span class="n">new_test_file</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>dealing /content/data/fb15k/train.txt
dealing /content/data/fb15k/train.txt
dealing /content/data/fb15k/train.txt
&gt;&gt; Number of unique entities: 14951
&gt;&gt; Number of unique relations: 1345
&gt;&gt; vocab_size: 16396
&gt;&gt; Number of true triples: 592213
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Args</span><span class="p">:</span>
    <span class="n">TASK</span><span class="o">=</span><span class="s1">&#39;fb15k&#39;</span>
    <span class="n">NUM_VOCAB</span><span class="o">=</span><span class="mi">16396</span>  <span class="c1">#NUM_VOCAB and NUM_RELATIONS must be consistent with vocab.txt file </span>
    <span class="n">NUM_RELATIONS</span><span class="o">=</span><span class="mi">1345</span>

    <span class="c1"># training hyper-paramters</span>
    <span class="n">BATCH_SIZE</span><span class="o">=</span><span class="mi">512</span>
    <span class="n">LEARNING_RATE</span><span class="o">=</span><span class="mf">5e-4</span>
    <span class="n">EPOCH</span><span class="o">=</span><span class="mi">400</span>
    <span class="n">SOFT_LABEL</span><span class="o">=</span><span class="mf">0.8</span>
    <span class="n">SKIP_STEPS</span><span class="o">=</span><span class="mi">1000</span>
    <span class="n">MAX_SEQ_LEN</span><span class="o">=</span><span class="mi">3</span>
    <span class="n">HIDDEN_DROPOUT_PROB</span><span class="o">=</span><span class="mf">0.1</span>
    <span class="n">ATTENTION_PROBS_DROPOUT_PROB</span><span class="o">=</span><span class="mf">0.1</span>

    <span class="c1"># file paths for training and evaluation </span>
    <span class="n">DATA</span><span class="o">=</span><span class="s2">&quot;./data&quot;</span>
    <span class="n">OUTPUT</span><span class="o">=</span><span class="s2">&quot;./output_fb15k&quot;</span>
    <span class="n">TRAIN_FILE</span><span class="o">=</span><span class="s2">&quot;./data/fb15k/train.coke.txt&quot;</span>
    <span class="n">VALID_FILE</span><span class="o">=</span><span class="s2">&quot;./data/fb15k/valid.coke.txt&quot;</span>
    <span class="n">TEST_FILE</span><span class="o">=</span><span class="s2">&quot;./data/fb15k/test.coke.txt&quot;</span>
    <span class="n">VOCAB_PATH</span><span class="o">=</span><span class="s2">&quot;./data/fb15k/vocab.txt&quot;</span>
    <span class="n">TRUE_TRIPLE_PATH</span><span class="o">=</span><span class="s2">&quot;./data/fb15k/all.txt&quot;</span>
    <span class="n">CHECKPOINTS</span><span class="o">=</span><span class="s2">&quot;./output_fb15k/models&quot;</span>
    <span class="n">INIT_CHECKPOINTS</span><span class="o">=</span><span class="n">CHECKPOINTS</span>
    <span class="n">LOG_FILE</span><span class="o">=</span><span class="s2">&quot;./output_fb15k/train.log&quot;</span>
    <span class="n">LOG_EVAL_FILE</span><span class="o">=</span><span class="s2">&quot;./output_fb15k/test.log&quot;</span>

    <span class="c1"># transformer net config the follwoing are default configs for all tasks</span>
    <span class="n">HIDDEN_SIZE</span><span class="o">=</span><span class="mi">256</span>
    <span class="n">NUM_HIDDEN_LAYERS</span><span class="o">=</span><span class="mi">12</span>
    <span class="n">NUM_ATTENTION_HEADS</span><span class="o">=</span><span class="mi">4</span>
    <span class="n">MAX_POSITION_EMBEDDINS</span><span class="o">=</span><span class="mi">40</span>

    <span class="n">hidden_size</span><span class="o">=</span><span class="mi">256</span>
    <span class="n">num_hidden_layers</span><span class="o">=</span><span class="mi">6</span>
    <span class="n">num_attention_heads</span><span class="o">=</span><span class="mi">4</span>
    <span class="n">vocab_size</span><span class="o">=-</span><span class="mi">1</span>
    <span class="n">num_relations</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">max_position_embeddings</span><span class="o">=</span><span class="mi">10</span>
    <span class="n">hidden_act</span><span class="o">=</span><span class="s2">&quot;gelu&quot;</span>
    <span class="n">hidden_dropout_prob</span><span class="o">=</span><span class="mf">0.1</span>
    <span class="n">attention_probs_dropout_prob</span><span class="o">=</span><span class="mf">0.1</span>
    <span class="n">initializer_range</span><span class="o">=</span><span class="mf">0.02</span>
    <span class="n">intermediate_size</span><span class="o">=</span><span class="mi">512</span>
    <span class="n">init_checkpoint</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">init_pretraining_params</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">checkpoints</span><span class="o">=</span><span class="s2">&quot;checkpoints&quot;</span>
    <span class="n">weight_sharing</span><span class="o">=</span><span class="kc">True</span>
    <span class="n">epoch</span><span class="o">=</span><span class="mi">100</span>
    <span class="n">learning_rate</span><span class="o">=</span><span class="mf">5e-5</span>
    <span class="n">lr_scheduler</span><span class="o">=</span><span class="s2">&quot;linear_warmup_decay&quot;</span>
    <span class="n">soft_label</span><span class="o">=</span><span class="mf">0.9</span>
    <span class="n">weight_decay</span><span class="o">=</span><span class="mf">0.01</span>
    <span class="n">warmup_proportion</span><span class="o">=</span><span class="mf">0.1</span>
    <span class="n">use_ema</span><span class="o">=</span><span class="kc">True</span>
    <span class="n">ema_decay</span><span class="o">=</span><span class="mf">0.9999</span>
    <span class="n">use_fp16</span><span class="o">=</span><span class="kc">False</span>
    <span class="n">loss_scaling</span><span class="o">=</span><span class="mf">1.0</span>
    <span class="n">skip_steps</span><span class="o">=</span><span class="mi">1000</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span>
    <span class="n">dataset</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
    <span class="n">train_file</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">sen_candli_file</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">sen_trivial_file</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">predict_file</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">vocab_path</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">true_triple_path</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">max_seq_len</span><span class="o">=</span><span class="mi">3</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="mi">12</span>
    <span class="n">in_tokens</span><span class="o">=</span><span class="kc">False</span>
    <span class="n">do_train</span><span class="o">=</span><span class="kc">False</span>
    <span class="n">do_predict</span><span class="o">=</span><span class="kc">False</span>
    <span class="n">use_cuda</span><span class="o">=</span><span class="kc">False</span>
    <span class="n">use_fast_executor</span><span class="o">=</span><span class="kc">False</span>
    <span class="n">num_iteration_per_drop_scope</span><span class="o">=</span><span class="mi">1</span>

<span class="n">args</span> <span class="o">=</span><span class="n">Args</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>!pip install -q paddlepaddle
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">six</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">paddle</span>
<span class="kn">import</span> <span class="nn">paddle.fluid</span> <span class="k">as</span> <span class="nn">fluid</span>

<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span><span class="p">,</span> <span class="n">reduce</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">paddle.fluid</span> <span class="k">as</span> <span class="nn">fluid</span>
<span class="kn">import</span> <span class="nn">paddle.fluid.layers</span> <span class="k">as</span> <span class="nn">layers</span>
<span class="kn">from</span> <span class="nn">paddle.fluid.layer_helper</span> <span class="kn">import</span> <span class="n">LayerHelper</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">six</span>
<span class="kn">import</span> <span class="nn">ast</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">paddle.fluid</span> <span class="k">as</span> <span class="nn">fluid</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>
    <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> - </span><span class="si">%(levelname)s</span><span class="s1"> - </span><span class="si">%(name)s</span><span class="s1"> - </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,</span>
    <span class="n">datefmt</span><span class="o">=</span><span class="s1">&#39;%m/</span><span class="si">%d</span><span class="s1">/%Y %H:%M:%S&#39;</span><span class="p">,</span>
    <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
<span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">str2bool</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
    <span class="c1"># because argparse does not support to parse &quot;true, False&quot; as python</span>
    <span class="c1"># boolean directly</span>
    <span class="k">return</span> <span class="n">v</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;true&quot;</span><span class="p">,</span> <span class="s2">&quot;t&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ArgumentGroup</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parser</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">des</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_group</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">des</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_arg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">default</span><span class="p">,</span> <span class="n">help</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">type</span> <span class="o">=</span> <span class="n">str2bool</span> <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="nb">bool</span> <span class="k">else</span> <span class="nb">type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;--&quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="nb">type</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="n">help</span> <span class="o">+</span> <span class="s1">&#39; Default: </span><span class="si">%(default)s</span><span class="s1">.&#39;</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">print_arguments</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;-----------  Configuration Arguments -----------&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">arg</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="nb">vars</span><span class="p">(</span><span class="n">args</span><span class="p">))):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;------------------------------------------------&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">cast_fp16_to_fp32</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">prog</span><span class="p">):</span>
    <span class="n">prog</span><span class="o">.</span><span class="n">global_block</span><span class="p">()</span><span class="o">.</span><span class="n">append_op</span><span class="p">(</span>
        <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;cast&quot;</span><span class="p">,</span>
        <span class="n">inputs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;X&quot;</span><span class="p">:</span> <span class="n">i</span><span class="p">},</span>
        <span class="n">outputs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Out&quot;</span><span class="p">:</span> <span class="n">o</span><span class="p">},</span>
        <span class="n">attrs</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;in_dtype&quot;</span><span class="p">:</span> <span class="n">fluid</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">VarDesc</span><span class="o">.</span><span class="n">VarType</span><span class="o">.</span><span class="n">FP16</span><span class="p">,</span>
            <span class="s2">&quot;out_dtype&quot;</span><span class="p">:</span> <span class="n">fluid</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">VarDesc</span><span class="o">.</span><span class="n">VarType</span><span class="o">.</span><span class="n">FP32</span>
        <span class="p">})</span>


<span class="k">def</span> <span class="nf">cast_fp32_to_fp16</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">prog</span><span class="p">):</span>
    <span class="n">prog</span><span class="o">.</span><span class="n">global_block</span><span class="p">()</span><span class="o">.</span><span class="n">append_op</span><span class="p">(</span>
        <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;cast&quot;</span><span class="p">,</span>
        <span class="n">inputs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;X&quot;</span><span class="p">:</span> <span class="n">i</span><span class="p">},</span>
        <span class="n">outputs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Out&quot;</span><span class="p">:</span> <span class="n">o</span><span class="p">},</span>
        <span class="n">attrs</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;in_dtype&quot;</span><span class="p">:</span> <span class="n">fluid</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">VarDesc</span><span class="o">.</span><span class="n">VarType</span><span class="o">.</span><span class="n">FP32</span><span class="p">,</span>
            <span class="s2">&quot;out_dtype&quot;</span><span class="p">:</span> <span class="n">fluid</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">VarDesc</span><span class="o">.</span><span class="n">VarType</span><span class="o">.</span><span class="n">FP16</span>
        <span class="p">})</span>


<span class="k">def</span> <span class="nf">copy_to_master_param</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">block</span><span class="p">):</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="n">vars</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;no param name </span><span class="si">%s</span><span class="s2"> found!&quot;</span> <span class="o">%</span> <span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="n">new_p</span> <span class="o">=</span> <span class="n">fluid</span><span class="o">.</span><span class="n">framework</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span>
        <span class="n">block</span><span class="o">=</span><span class="n">block</span><span class="p">,</span>
        <span class="n">shape</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">fluid</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">VarDesc</span><span class="o">.</span><span class="n">VarType</span><span class="o">.</span><span class="n">FP32</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
        <span class="n">lod_level</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="n">lod_level</span><span class="p">,</span>
        <span class="n">stop_gradient</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">stop_gradient</span><span class="p">,</span>
        <span class="n">trainable</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">trainable</span><span class="p">,</span>
        <span class="n">optimize_attr</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">optimize_attr</span><span class="p">,</span>
        <span class="n">regularizer</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">regularizer</span><span class="p">,</span>
        <span class="n">gradient_clip_attr</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">gradient_clip_attr</span><span class="p">,</span>
        <span class="n">error_clip</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">error_clip</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;.master&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">new_p</span>


<span class="k">def</span> <span class="nf">create_master_params_grads</span><span class="p">(</span><span class="n">params_grads</span><span class="p">,</span> <span class="n">main_prog</span><span class="p">,</span> <span class="n">startup_prog</span><span class="p">,</span>
                               <span class="n">loss_scaling</span><span class="p">):</span>
    <span class="n">master_params_grads</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">tmp_role</span> <span class="o">=</span> <span class="n">main_prog</span><span class="o">.</span><span class="n">_current_role</span>
    <span class="n">OpRole</span> <span class="o">=</span> <span class="n">fluid</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">op_proto_and_checker_maker</span><span class="o">.</span><span class="n">OpRole</span>
    <span class="n">main_prog</span><span class="o">.</span><span class="n">_current_role</span> <span class="o">=</span> <span class="n">OpRole</span><span class="o">.</span><span class="n">Backward</span>
    <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">params_grads</span><span class="p">:</span>
        <span class="c1"># create master parameters</span>
        <span class="n">master_param</span> <span class="o">=</span> <span class="n">copy_to_master_param</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">main_prog</span><span class="o">.</span><span class="n">global_block</span><span class="p">())</span>
        <span class="n">startup_master_param</span> <span class="o">=</span> <span class="n">startup_prog</span><span class="o">.</span><span class="n">global_block</span><span class="p">()</span><span class="o">.</span><span class="n">_clone_variable</span><span class="p">(</span>
            <span class="n">master_param</span><span class="p">)</span>
        <span class="n">startup_p</span> <span class="o">=</span> <span class="n">startup_prog</span><span class="o">.</span><span class="n">global_block</span><span class="p">()</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">cast_fp16_to_fp32</span><span class="p">(</span><span class="n">startup_p</span><span class="p">,</span> <span class="n">startup_master_param</span><span class="p">,</span> <span class="n">startup_prog</span><span class="p">)</span>
        <span class="c1"># cast fp16 gradients to fp32 before apply gradients</span>
        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;layer_norm&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">loss_scaling</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">scaled_g</span> <span class="o">=</span> <span class="n">g</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">loss_scaling</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">scaled_g</span> <span class="o">=</span> <span class="n">g</span>
            <span class="n">master_params_grads</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">p</span><span class="p">,</span> <span class="n">scaled_g</span><span class="p">])</span>
            <span class="k">continue</span>
        <span class="n">master_grad</span> <span class="o">=</span> <span class="n">fluid</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="s2">&quot;float32&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">loss_scaling</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">master_grad</span> <span class="o">=</span> <span class="n">master_grad</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">loss_scaling</span><span class="p">)</span>
        <span class="n">master_params_grads</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">master_param</span><span class="p">,</span> <span class="n">master_grad</span><span class="p">])</span>
    <span class="n">main_prog</span><span class="o">.</span><span class="n">_current_role</span> <span class="o">=</span> <span class="n">tmp_role</span>
    <span class="k">return</span> <span class="n">master_params_grads</span>


<span class="k">def</span> <span class="nf">master_param_to_train_param</span><span class="p">(</span><span class="n">master_params_grads</span><span class="p">,</span> <span class="n">params_grads</span><span class="p">,</span> <span class="n">main_prog</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">m_p_g</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">master_params_grads</span><span class="p">):</span>
        <span class="n">train_p</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">params_grads</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">train_p</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;layer_norm&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">with</span> <span class="n">main_prog</span><span class="o">.</span><span class="n">_optimized_guard</span><span class="p">([</span><span class="n">m_p_g</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">m_p_g</span><span class="p">[</span><span class="mi">1</span><span class="p">]]):</span>
            <span class="n">cast_fp32_to_fp16</span><span class="p">(</span><span class="n">m_p_g</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">train_p</span><span class="p">,</span> <span class="n">main_prog</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">layer_norm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span>
               <span class="n">begin_norm_axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
               <span class="n">epsilon</span><span class="o">=</span><span class="mf">1e-12</span><span class="p">,</span>
               <span class="n">param_attr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="n">bias_attr</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Replace build-in layer_norm op with this function</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">helper</span> <span class="o">=</span> <span class="n">LayerHelper</span><span class="p">(</span><span class="s1">&#39;layer_norm&#39;</span><span class="p">,</span> <span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
    <span class="n">mean</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="n">begin_norm_axis</span><span class="p">,</span> <span class="n">keep_dim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">shift_x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">elementwise_sub</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">mean</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">variance</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span>
        <span class="n">layers</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">shift_x</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="n">begin_norm_axis</span><span class="p">,</span> <span class="n">keep_dim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">r_stdev</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">rsqrt</span><span class="p">(</span><span class="n">variance</span> <span class="o">+</span> <span class="n">epsilon</span><span class="p">)</span>
    <span class="n">norm_x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">elementwise_mul</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">shift_x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">r_stdev</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">param_shape</span> <span class="o">=</span> <span class="p">[</span><span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">*</span> <span class="n">y</span><span class="p">,</span> <span class="n">norm_x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">begin_norm_axis</span><span class="p">:])]</span>
    <span class="n">param_dtype</span> <span class="o">=</span> <span class="n">norm_x</span><span class="o">.</span><span class="n">dtype</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">create_parameter</span><span class="p">(</span>
        <span class="n">attr</span><span class="o">=</span><span class="n">param_attr</span><span class="p">,</span>
        <span class="n">shape</span><span class="o">=</span><span class="n">param_shape</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">param_dtype</span><span class="p">,</span>
        <span class="n">default_initializer</span><span class="o">=</span><span class="n">fluid</span><span class="o">.</span><span class="n">initializer</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="mf">1.</span><span class="p">))</span>
    <span class="n">bias</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">create_parameter</span><span class="p">(</span>
        <span class="n">attr</span><span class="o">=</span><span class="n">bias_attr</span><span class="p">,</span>
        <span class="n">shape</span><span class="o">=</span><span class="n">param_shape</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">param_dtype</span><span class="p">,</span>
        <span class="n">is_bias</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">default_initializer</span><span class="o">=</span><span class="n">fluid</span><span class="o">.</span><span class="n">initializer</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="mf">0.</span><span class="p">))</span>

    <span class="n">out</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">elementwise_mul</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">norm_x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">elementwise_add</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">out</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">bias</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">out</span>


<span class="k">def</span> <span class="nf">multi_head_attention</span><span class="p">(</span><span class="n">queries</span><span class="p">,</span>
                         <span class="n">keys</span><span class="p">,</span>
                         <span class="n">values</span><span class="p">,</span>
                         <span class="n">attn_bias</span><span class="p">,</span>
                         <span class="n">d_key</span><span class="p">,</span>
                         <span class="n">d_value</span><span class="p">,</span>
                         <span class="n">d_model</span><span class="p">,</span>
                         <span class="n">n_head</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                         <span class="n">dropout_rate</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
                         <span class="n">cache</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">param_initializer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">name</span><span class="o">=</span><span class="s1">&#39;multi_head_att&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Multi-Head Attention. Note that attn_bias is added to the logit before</span>
<span class="sd">    computing softmax activiation to mask certain selected positions so that</span>
<span class="sd">    they will not considered in attention weights.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="n">queries</span> <span class="k">if</span> <span class="n">keys</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">keys</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">keys</span> <span class="k">if</span> <span class="n">values</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">values</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">queries</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Inputs: quries, keys and values should all be 3-D tensors.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__compute_qkv</span><span class="p">(</span><span class="n">queries</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">n_head</span><span class="p">,</span> <span class="n">d_key</span><span class="p">,</span> <span class="n">d_value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add linear projection to queries, keys, and values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">fc</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">queries</span><span class="p">,</span>
                      <span class="n">size</span><span class="o">=</span><span class="n">d_key</span> <span class="o">*</span> <span class="n">n_head</span><span class="p">,</span>
                      <span class="n">num_flatten_dims</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                      <span class="n">param_attr</span><span class="o">=</span><span class="n">fluid</span><span class="o">.</span><span class="n">ParamAttr</span><span class="p">(</span>
                          <span class="n">name</span><span class="o">=</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_query_fc.w_0&#39;</span><span class="p">,</span>
                          <span class="n">initializer</span><span class="o">=</span><span class="n">param_initializer</span><span class="p">),</span>
                      <span class="n">bias_attr</span><span class="o">=</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_query_fc.b_0&#39;</span><span class="p">)</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">fc</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">keys</span><span class="p">,</span>
                      <span class="n">size</span><span class="o">=</span><span class="n">d_key</span> <span class="o">*</span> <span class="n">n_head</span><span class="p">,</span>
                      <span class="n">num_flatten_dims</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                      <span class="n">param_attr</span><span class="o">=</span><span class="n">fluid</span><span class="o">.</span><span class="n">ParamAttr</span><span class="p">(</span>
                          <span class="n">name</span><span class="o">=</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_key_fc.w_0&#39;</span><span class="p">,</span>
                          <span class="n">initializer</span><span class="o">=</span><span class="n">param_initializer</span><span class="p">),</span>
                      <span class="n">bias_attr</span><span class="o">=</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_key_fc.b_0&#39;</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">fc</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">values</span><span class="p">,</span>
                      <span class="n">size</span><span class="o">=</span><span class="n">d_value</span> <span class="o">*</span> <span class="n">n_head</span><span class="p">,</span>
                      <span class="n">num_flatten_dims</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                      <span class="n">param_attr</span><span class="o">=</span><span class="n">fluid</span><span class="o">.</span><span class="n">ParamAttr</span><span class="p">(</span>
                          <span class="n">name</span><span class="o">=</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_value_fc.w_0&#39;</span><span class="p">,</span>
                          <span class="n">initializer</span><span class="o">=</span><span class="n">param_initializer</span><span class="p">),</span>
                      <span class="n">bias_attr</span><span class="o">=</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_value_fc.b_0&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">q</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span>

    <span class="k">def</span> <span class="nf">__split_heads</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">n_head</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reshape the last dimension of inpunt tensor x so that it becomes two</span>
<span class="sd">        dimensions and then transpose. Specifically, input a tensor with shape</span>
<span class="sd">        [bs, max_sequence_length, n_head * hidden_dim] then output a tensor</span>
<span class="sd">        with shape [bs, n_head, max_sequence_length, hidden_dim].</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hidden_size</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># The value 0 in shape attr means copying the corresponding dimension</span>
        <span class="c1"># size of the input as the output dimension size.</span>
        <span class="n">reshaped</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n_head</span><span class="p">,</span> <span class="n">hidden_size</span> <span class="o">//</span> <span class="n">n_head</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># permuate the dimensions into:</span>
        <span class="c1"># [batch_size, n_head, max_sequence_len, hidden_size_per_head]</span>
        <span class="k">return</span> <span class="n">layers</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">reshaped</span><span class="p">,</span> <span class="n">perm</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">__combine_heads</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transpose and then reshape the last two dimensions of inpunt tensor x</span>
<span class="sd">        so that it becomes one dimension, which is reverse to __split_heads.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span> <span class="k">return</span> <span class="n">x</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Input(x) should be a 4-D Tensor.&quot;</span><span class="p">)</span>

        <span class="n">trans_x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">perm</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
        <span class="c1"># The value 0 in shape attr means copying the corresponding dimension</span>
        <span class="c1"># size of the input as the output dimension size.</span>
        <span class="k">return</span> <span class="n">layers</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">trans_x</span><span class="p">,</span>
            <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">trans_x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">trans_x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]],</span>
            <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">scaled_dot_product_attention</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">attn_bias</span><span class="p">,</span> <span class="n">d_key</span><span class="p">,</span> <span class="n">dropout_rate</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Scaled Dot-Product Attention</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">scaled_q</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">q</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">d_key</span><span class="o">**-</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">product</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">scaled_q</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">transpose_y</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">attn_bias</span><span class="p">:</span>
            <span class="n">product</span> <span class="o">+=</span> <span class="n">attn_bias</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">product</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dropout_rate</span><span class="p">:</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span>
                <span class="n">weights</span><span class="p">,</span>
                <span class="n">dropout_prob</span><span class="o">=</span><span class="n">dropout_rate</span><span class="p">,</span>
                <span class="n">dropout_implementation</span><span class="o">=</span><span class="s2">&quot;upscale_in_train&quot;</span><span class="p">,</span>
                <span class="n">is_test</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="n">q</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">__compute_qkv</span><span class="p">(</span><span class="n">queries</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">n_head</span><span class="p">,</span> <span class="n">d_key</span><span class="p">,</span> <span class="n">d_value</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">cache</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># use cache and concat time steps</span>
        <span class="c1"># Since the inplace reshape in __split_heads changes the shape of k and</span>
        <span class="c1"># v, which is the cache input for next time step, reshape the cache</span>
        <span class="c1"># input from the previous time step first.</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">cache</span><span class="p">[</span><span class="s2">&quot;k&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
            <span class="p">[</span><span class="n">layers</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                <span class="n">cache</span><span class="p">[</span><span class="s2">&quot;k&quot;</span><span class="p">],</span> <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">d_model</span><span class="p">]),</span> <span class="n">k</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">cache</span><span class="p">[</span><span class="s2">&quot;v&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
            <span class="p">[</span><span class="n">layers</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                <span class="n">cache</span><span class="p">[</span><span class="s2">&quot;v&quot;</span><span class="p">],</span> <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">d_model</span><span class="p">]),</span> <span class="n">v</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">q</span> <span class="o">=</span> <span class="n">__split_heads</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">n_head</span><span class="p">)</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">__split_heads</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">n_head</span><span class="p">)</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">__split_heads</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">n_head</span><span class="p">)</span>

    <span class="n">ctx_multiheads</span> <span class="o">=</span> <span class="n">scaled_dot_product_attention</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">attn_bias</span><span class="p">,</span> <span class="n">d_key</span><span class="p">,</span>
                                                  <span class="n">dropout_rate</span><span class="p">)</span>

    <span class="n">out</span> <span class="o">=</span> <span class="n">__combine_heads</span><span class="p">(</span><span class="n">ctx_multiheads</span><span class="p">)</span>

    <span class="c1"># Project back to the model size.</span>
    <span class="n">proj_out</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">fc</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">out</span><span class="p">,</span>
                         <span class="n">size</span><span class="o">=</span><span class="n">d_model</span><span class="p">,</span>
                         <span class="n">num_flatten_dims</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                         <span class="n">param_attr</span><span class="o">=</span><span class="n">fluid</span><span class="o">.</span><span class="n">ParamAttr</span><span class="p">(</span>
                             <span class="n">name</span><span class="o">=</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_output_fc.w_0&#39;</span><span class="p">,</span>
                             <span class="n">initializer</span><span class="o">=</span><span class="n">param_initializer</span><span class="p">),</span>
                         <span class="n">bias_attr</span><span class="o">=</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_output_fc.b_0&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">proj_out</span>


<span class="k">def</span> <span class="nf">positionwise_feed_forward</span><span class="p">(</span><span class="n">x</span><span class="p">,</span>
                              <span class="n">d_inner_hid</span><span class="p">,</span>
                              <span class="n">d_hid</span><span class="p">,</span>
                              <span class="n">dropout_rate</span><span class="p">,</span>
                              <span class="n">hidden_act</span><span class="p">,</span>
                              <span class="n">param_initializer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                              <span class="n">name</span><span class="o">=</span><span class="s1">&#39;ffn&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Position-wise Feed-Forward Networks.</span>
<span class="sd">    This module consists of two linear transformations with a ReLU activation</span>
<span class="sd">    in between, which is applied to each position separately and identically.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">hidden</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">fc</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">x</span><span class="p">,</span>
                       <span class="n">size</span><span class="o">=</span><span class="n">d_inner_hid</span><span class="p">,</span>
                       <span class="n">num_flatten_dims</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                       <span class="n">act</span><span class="o">=</span><span class="n">hidden_act</span><span class="p">,</span>
                       <span class="n">param_attr</span><span class="o">=</span><span class="n">fluid</span><span class="o">.</span><span class="n">ParamAttr</span><span class="p">(</span>
                           <span class="n">name</span><span class="o">=</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_fc_0.w_0&#39;</span><span class="p">,</span>
                           <span class="n">initializer</span><span class="o">=</span><span class="n">param_initializer</span><span class="p">),</span>
                       <span class="n">bias_attr</span><span class="o">=</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_fc_0.b_0&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dropout_rate</span><span class="p">:</span>
        <span class="n">hidden</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span>
            <span class="n">hidden</span><span class="p">,</span>
            <span class="n">dropout_prob</span><span class="o">=</span><span class="n">dropout_rate</span><span class="p">,</span>
            <span class="n">dropout_implementation</span><span class="o">=</span><span class="s2">&quot;upscale_in_train&quot;</span><span class="p">,</span>
            <span class="n">is_test</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">fc</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">hidden</span><span class="p">,</span>
                    <span class="n">size</span><span class="o">=</span><span class="n">d_hid</span><span class="p">,</span>
                    <span class="n">num_flatten_dims</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                    <span class="n">param_attr</span><span class="o">=</span><span class="n">fluid</span><span class="o">.</span><span class="n">ParamAttr</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">=</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_fc_1.w_0&#39;</span><span class="p">,</span>
                        <span class="n">initializer</span><span class="o">=</span><span class="n">param_initializer</span><span class="p">),</span>
                    <span class="n">bias_attr</span><span class="o">=</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_fc_1.b_0&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>


<span class="k">def</span> <span class="nf">pre_post_process_layer</span><span class="p">(</span><span class="n">prev_out</span><span class="p">,</span>
                           <span class="n">out</span><span class="p">,</span>
                           <span class="n">process_cmd</span><span class="p">,</span>
                           <span class="n">dropout_rate</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
                           <span class="n">name</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add residual connection, layer normalization and droput to the out tensor</span>
<span class="sd">    optionally according to the value of process_cmd.</span>
<span class="sd">    This will be used before or after multi-head attention and position-wise</span>
<span class="sd">    feed-forward networks.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">process_cmd</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">&quot;a&quot;</span><span class="p">:</span>  <span class="c1"># add residual connection</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">out</span> <span class="o">+</span> <span class="n">prev_out</span> <span class="k">if</span> <span class="n">prev_out</span> <span class="k">else</span> <span class="n">out</span>
        <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">&quot;n&quot;</span><span class="p">:</span>  <span class="c1"># add layer normalization</span>
            <span class="n">out_dtype</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">dtype</span>
            <span class="k">if</span> <span class="n">out_dtype</span> <span class="o">==</span> <span class="n">fluid</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">VarDesc</span><span class="o">.</span><span class="n">VarType</span><span class="o">.</span><span class="n">FP16</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">out</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span><span class="p">)</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">layer_norm</span><span class="p">(</span>
                <span class="n">out</span><span class="p">,</span>
                <span class="n">begin_norm_axis</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                <span class="n">param_attr</span><span class="o">=</span><span class="n">fluid</span><span class="o">.</span><span class="n">ParamAttr</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_layer_norm_scale&#39;</span><span class="p">,</span>
                    <span class="n">initializer</span><span class="o">=</span><span class="n">fluid</span><span class="o">.</span><span class="n">initializer</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="mf">1.</span><span class="p">)),</span>
                <span class="n">bias_attr</span><span class="o">=</span><span class="n">fluid</span><span class="o">.</span><span class="n">ParamAttr</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_layer_norm_bias&#39;</span><span class="p">,</span>
                    <span class="n">initializer</span><span class="o">=</span><span class="n">fluid</span><span class="o">.</span><span class="n">initializer</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="mf">0.</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">out_dtype</span> <span class="o">==</span> <span class="n">fluid</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">VarDesc</span><span class="o">.</span><span class="n">VarType</span><span class="o">.</span><span class="n">FP16</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">out</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float16&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">&quot;d&quot;</span><span class="p">:</span>  <span class="c1"># add dropout</span>
            <span class="k">if</span> <span class="n">dropout_rate</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span>
                    <span class="n">out</span><span class="p">,</span>
                    <span class="n">dropout_prob</span><span class="o">=</span><span class="n">dropout_rate</span><span class="p">,</span>
                    <span class="n">dropout_implementation</span><span class="o">=</span><span class="s2">&quot;upscale_in_train&quot;</span><span class="p">,</span>
                    <span class="n">is_test</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>


<span class="n">pre_process_layer</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">pre_post_process_layer</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="n">post_process_layer</span> <span class="o">=</span> <span class="n">pre_post_process_layer</span>


<span class="k">def</span> <span class="nf">encoder_layer</span><span class="p">(</span><span class="n">enc_input</span><span class="p">,</span>
                  <span class="n">attn_bias</span><span class="p">,</span>
                  <span class="n">n_head</span><span class="p">,</span>
                  <span class="n">d_key</span><span class="p">,</span>
                  <span class="n">d_value</span><span class="p">,</span>
                  <span class="n">d_model</span><span class="p">,</span>
                  <span class="n">d_inner_hid</span><span class="p">,</span>
                  <span class="n">prepostprocess_dropout</span><span class="p">,</span>
                  <span class="n">attention_dropout</span><span class="p">,</span>
                  <span class="n">relu_dropout</span><span class="p">,</span>
                  <span class="n">hidden_act</span><span class="p">,</span>
                  <span class="n">preprocess_cmd</span><span class="o">=</span><span class="s2">&quot;n&quot;</span><span class="p">,</span>
                  <span class="n">postprocess_cmd</span><span class="o">=</span><span class="s2">&quot;da&quot;</span><span class="p">,</span>
                  <span class="n">param_initializer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">name</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The encoder layers that can be stacked to form a deep encoder.</span>
<span class="sd">    This module consits of a multi-head (self) attention followed by</span>
<span class="sd">    position-wise feed-forward networks and both the two components companied</span>
<span class="sd">    with the post_process_layer to add residual connection, layer normalization</span>
<span class="sd">    and droput.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">attn_output</span> <span class="o">=</span> <span class="n">multi_head_attention</span><span class="p">(</span>
        <span class="n">pre_process_layer</span><span class="p">(</span>
            <span class="n">enc_input</span><span class="p">,</span>
            <span class="n">preprocess_cmd</span><span class="p">,</span>
            <span class="n">prepostprocess_dropout</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_pre_att&#39;</span><span class="p">),</span>
        <span class="kc">None</span><span class="p">,</span>
        <span class="kc">None</span><span class="p">,</span>
        <span class="n">attn_bias</span><span class="p">,</span>
        <span class="n">d_key</span><span class="p">,</span>
        <span class="n">d_value</span><span class="p">,</span>
        <span class="n">d_model</span><span class="p">,</span>
        <span class="n">n_head</span><span class="p">,</span>
        <span class="n">attention_dropout</span><span class="p">,</span>
        <span class="n">param_initializer</span><span class="o">=</span><span class="n">param_initializer</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_multi_head_att&#39;</span><span class="p">)</span>
    <span class="n">attn_output</span> <span class="o">=</span> <span class="n">post_process_layer</span><span class="p">(</span>
        <span class="n">enc_input</span><span class="p">,</span>
        <span class="n">attn_output</span><span class="p">,</span>
        <span class="n">postprocess_cmd</span><span class="p">,</span>
        <span class="n">prepostprocess_dropout</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_post_att&#39;</span><span class="p">)</span>
    <span class="n">ffd_output</span> <span class="o">=</span> <span class="n">positionwise_feed_forward</span><span class="p">(</span>
        <span class="n">pre_process_layer</span><span class="p">(</span>
            <span class="n">attn_output</span><span class="p">,</span>
            <span class="n">preprocess_cmd</span><span class="p">,</span>
            <span class="n">prepostprocess_dropout</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_pre_ffn&#39;</span><span class="p">),</span>
        <span class="n">d_inner_hid</span><span class="p">,</span>
        <span class="n">d_model</span><span class="p">,</span>
        <span class="n">relu_dropout</span><span class="p">,</span>
        <span class="n">hidden_act</span><span class="p">,</span>
        <span class="n">param_initializer</span><span class="o">=</span><span class="n">param_initializer</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_ffn&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">post_process_layer</span><span class="p">(</span>
        <span class="n">attn_output</span><span class="p">,</span>
        <span class="n">ffd_output</span><span class="p">,</span>
        <span class="n">postprocess_cmd</span><span class="p">,</span>
        <span class="n">prepostprocess_dropout</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_post_ffn&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">encoder</span><span class="p">(</span><span class="n">enc_input</span><span class="p">,</span>
            <span class="n">attn_bias</span><span class="p">,</span>
            <span class="n">n_layer</span><span class="p">,</span>
            <span class="n">n_head</span><span class="p">,</span>
            <span class="n">d_key</span><span class="p">,</span>
            <span class="n">d_value</span><span class="p">,</span>
            <span class="n">d_model</span><span class="p">,</span>
            <span class="n">d_inner_hid</span><span class="p">,</span>
            <span class="n">prepostprocess_dropout</span><span class="p">,</span>
            <span class="n">attention_dropout</span><span class="p">,</span>
            <span class="n">relu_dropout</span><span class="p">,</span>
            <span class="n">hidden_act</span><span class="p">,</span>
            <span class="n">preprocess_cmd</span><span class="o">=</span><span class="s2">&quot;n&quot;</span><span class="p">,</span>
            <span class="n">postprocess_cmd</span><span class="o">=</span><span class="s2">&quot;da&quot;</span><span class="p">,</span>
            <span class="n">param_initializer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The encoder is composed of a stack of identical layers returned by calling</span>
<span class="sd">    encoder_layer.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_layer</span><span class="p">):</span>
        <span class="n">enc_output</span> <span class="o">=</span> <span class="n">encoder_layer</span><span class="p">(</span>
            <span class="n">enc_input</span><span class="p">,</span>
            <span class="n">attn_bias</span><span class="p">,</span>
            <span class="n">n_head</span><span class="p">,</span>
            <span class="n">d_key</span><span class="p">,</span>
            <span class="n">d_value</span><span class="p">,</span>
            <span class="n">d_model</span><span class="p">,</span>
            <span class="n">d_inner_hid</span><span class="p">,</span>
            <span class="n">prepostprocess_dropout</span><span class="p">,</span>
            <span class="n">attention_dropout</span><span class="p">,</span>
            <span class="n">relu_dropout</span><span class="p">,</span>
            <span class="n">hidden_act</span><span class="p">,</span>
            <span class="n">preprocess_cmd</span><span class="p">,</span>
            <span class="n">postprocess_cmd</span><span class="p">,</span>
            <span class="n">param_initializer</span><span class="o">=</span><span class="n">param_initializer</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_layer_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
        <span class="n">enc_input</span> <span class="o">=</span> <span class="n">enc_output</span>
    <span class="n">enc_output</span> <span class="o">=</span> <span class="n">pre_process_layer</span><span class="p">(</span>
        <span class="n">enc_output</span><span class="p">,</span>
        <span class="n">preprocess_cmd</span><span class="p">,</span>
        <span class="n">prepostprocess_dropout</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;post_encoder&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">enc_output</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">mask</span><span class="p">(</span><span class="n">input_tokens</span><span class="p">,</span> <span class="n">input_mask_type</span><span class="p">,</span> <span class="n">max_len</span><span class="p">,</span> <span class="n">mask_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add mask for batch_tokens, return out, mask_label, mask_pos;</span>
<span class="sd">    Note: mask_pos responding the batch_tokens after padded;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">output_tokens</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">mask_label</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">mask_pos</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">sent_index</span><span class="p">,</span> <span class="n">sent</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">input_tokens</span><span class="p">):</span>
        <span class="n">mask_type</span> <span class="o">=</span> <span class="n">input_mask_type</span><span class="p">[</span><span class="n">sent_index</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">mask_type</span> <span class="o">==</span> <span class="s2">&quot;MASK_HEAD&quot;</span><span class="p">:</span>
            <span class="n">token_index</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">mask_label</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sent</span><span class="p">[</span><span class="n">token_index</span><span class="p">])</span>
            <span class="n">mask_pos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sent_index</span> <span class="o">*</span> <span class="n">max_len</span> <span class="o">+</span> <span class="n">token_index</span><span class="p">)</span>
            <span class="n">sent_out</span> <span class="o">=</span> <span class="n">sent</span><span class="p">[:]</span>
            <span class="n">sent_out</span><span class="p">[</span><span class="n">token_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask_id</span>
            <span class="n">output_tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sent_out</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">mask_type</span> <span class="o">==</span> <span class="s2">&quot;MASK_TAIL&quot;</span><span class="p">:</span>
            <span class="n">token_index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sent</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">mask_label</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sent</span><span class="p">[</span><span class="n">token_index</span><span class="p">])</span>
            <span class="n">mask_pos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sent_index</span> <span class="o">*</span> <span class="n">max_len</span> <span class="o">+</span> <span class="n">token_index</span><span class="p">)</span>
            <span class="n">sent_out</span> <span class="o">=</span> <span class="n">sent</span><span class="p">[:]</span>
            <span class="n">sent_out</span><span class="p">[</span><span class="n">token_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask_id</span>
            <span class="n">output_tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sent_out</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Unknown mask type, which should be in [&#39;MASK_HEAD&#39;, &#39;MASK_TAIL&#39;].&quot;</span>
            <span class="p">)</span>
    <span class="n">mask_label</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mask_label</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;int64&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">mask_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mask_pos</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;int64&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">output_tokens</span><span class="p">,</span> <span class="n">mask_label</span><span class="p">,</span> <span class="n">mask_pos</span>


<span class="k">def</span> <span class="nf">pad_batch_data</span><span class="p">(</span><span class="n">insts</span><span class="p">,</span>
                   <span class="n">max_len</span><span class="p">,</span>
                   <span class="n">pad_idx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                   <span class="n">return_pos</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                   <span class="n">return_input_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Pad the instances to the max sequence length in batch, and generate the</span>
<span class="sd">    corresponding position data and input mask.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">return_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Any token included in dict can be used to pad, since the paddings&#39; loss</span>
    <span class="c1"># will be masked out by weights and make no effect on parameter gradients.</span>

    <span class="n">inst_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        <span class="nb">list</span><span class="p">(</span><span class="n">inst</span><span class="p">)</span> <span class="o">+</span> <span class="nb">list</span><span class="p">([</span><span class="n">pad_idx</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_len</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">inst</span><span class="p">)))</span> <span class="k">for</span> <span class="n">inst</span> <span class="ow">in</span> <span class="n">insts</span>
    <span class="p">])</span>
    <span class="n">return_list</span> <span class="o">+=</span> <span class="p">[</span><span class="n">inst_data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;int64&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_len</span><span class="p">,</span> <span class="mi">1</span><span class="p">])]</span>

    <span class="c1"># position data</span>
    <span class="k">if</span> <span class="n">return_pos</span><span class="p">:</span>
        <span class="n">inst_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">inst</span><span class="p">)))</span> <span class="o">+</span> <span class="p">[</span><span class="n">pad_idx</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_len</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">inst</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">inst</span> <span class="ow">in</span> <span class="n">insts</span>
        <span class="p">])</span>

        <span class="n">return_list</span> <span class="o">+=</span> <span class="p">[</span><span class="n">inst_pos</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;int64&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_len</span><span class="p">,</span> <span class="mi">1</span><span class="p">])]</span>

    <span class="k">if</span> <span class="n">return_input_mask</span><span class="p">:</span>
        <span class="c1"># This is used to avoid attention on paddings.</span>
        <span class="n">input_mask_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">inst</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span>
                                    <span class="p">(</span><span class="n">max_len</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">inst</span><span class="p">))</span> <span class="k">for</span> <span class="n">inst</span> <span class="ow">in</span> <span class="n">insts</span><span class="p">])</span>
        <span class="n">input_mask_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">input_mask_data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">return_list</span> <span class="o">+=</span> <span class="p">[</span><span class="n">input_mask_data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float32&quot;</span><span class="p">)]</span>

    <span class="k">return</span> <span class="n">return_list</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">return_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">return_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">prepare_batch_data</span><span class="p">(</span><span class="n">insts</span><span class="p">,</span> <span class="n">max_len</span><span class="p">,</span> <span class="n">pad_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mask_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; masking, padding, turn list data into numpy arrays, for batch examples</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">batch_src_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">inst</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">inst</span> <span class="ow">in</span> <span class="n">insts</span><span class="p">]</span>
    <span class="n">batch_mask_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">inst</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">inst</span> <span class="ow">in</span> <span class="n">insts</span><span class="p">]</span>

    <span class="c1"># First step: do mask without padding</span>
    <span class="k">if</span> <span class="n">mask_id</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">out</span><span class="p">,</span> <span class="n">mask_label</span><span class="p">,</span> <span class="n">mask_pos</span> <span class="o">=</span> <span class="n">mask</span><span class="p">(</span>
            <span class="n">input_tokens</span><span class="o">=</span><span class="n">batch_src_ids</span><span class="p">,</span>
            <span class="n">input_mask_type</span><span class="o">=</span><span class="n">batch_mask_type</span><span class="p">,</span>
            <span class="n">max_len</span><span class="o">=</span><span class="n">max_len</span><span class="p">,</span>
            <span class="n">mask_id</span><span class="o">=</span><span class="n">mask_id</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">batch_src_ids</span>

    <span class="c1"># Second step: padding and turn into numpy arrays</span>
    <span class="n">src_id</span><span class="p">,</span> <span class="n">pos_id</span><span class="p">,</span> <span class="n">input_mask</span> <span class="o">=</span> <span class="n">pad_batch_data</span><span class="p">(</span>
        <span class="n">out</span><span class="p">,</span>
        <span class="n">max_len</span><span class="o">=</span><span class="n">max_len</span><span class="p">,</span>
        <span class="n">pad_idx</span><span class="o">=</span><span class="n">pad_id</span><span class="p">,</span>
        <span class="n">return_pos</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">return_input_mask</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mask_id</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">return_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">src_id</span><span class="p">,</span> <span class="n">pos_id</span><span class="p">,</span> <span class="n">input_mask</span><span class="p">,</span> <span class="n">mask_label</span><span class="p">,</span> <span class="n">mask_pos</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">return_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">src_id</span><span class="p">,</span> <span class="n">pos_id</span><span class="p">,</span> <span class="n">input_mask</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">return_list</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">return_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">return_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">RawExample</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;RawExample&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;token_ids&quot;</span><span class="p">,</span> <span class="s2">&quot;mask_type&quot;</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">convert_to_unicode</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Converts `text` to Unicode (if it&#39;s not already), assuming utf-8 input.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">six</span><span class="o">.</span><span class="n">PY3</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">text</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">text</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unsupported string type: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">text</span><span class="p">)))</span>
    <span class="k">elif</span> <span class="n">six</span><span class="o">.</span><span class="n">PY2</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">text</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">unicode</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">text</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unsupported string type: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">text</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Not running on Python2 or Python 3?&quot;</span><span class="p">)</span>


<span class="c1">#def printable_text(text):</span>
<span class="c1">#    &quot;&quot;&quot;Returns text encoded in a way suitable for print or `tf.logging`.&quot;&quot;&quot;</span>
<span class="c1">#</span>
<span class="c1">#    # These functions want `str` for both Python2 and Python3, but in one case</span>
<span class="c1">#    # it&#39;s a Unicode string and in the other it&#39;s a byte string.</span>
<span class="c1">#    if six.PY3:</span>
<span class="c1">#        if isinstance(text, str):</span>
<span class="c1">#            return text</span>
<span class="c1">#        elif isinstance(text, bytes):</span>
<span class="c1">#            return text.decode(&quot;utf-8&quot;, &quot;ignore&quot;)</span>
<span class="c1">#        else:</span>
<span class="c1">#            raise ValueError(&quot;Unsupported string type: %s&quot; % (type(text)))</span>
<span class="c1">#    elif six.PY2:</span>
<span class="c1">#        if isinstance(text, str):</span>
<span class="c1">#            return text</span>
<span class="c1">#        elif isinstance(text, unicode):</span>
<span class="c1">#            return text.encode(&quot;utf-8&quot;)</span>
<span class="c1">#        else:</span>
<span class="c1">#            raise ValueError(&quot;Unsupported string type: %s&quot; % (type(text)))</span>
<span class="c1">#    else:</span>
<span class="c1">#        raise ValueError(&quot;Not running on Python2 or Python 3?&quot;)</span>


<span class="k">def</span> <span class="nf">load_vocab</span><span class="p">(</span><span class="n">vocab_file</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Loads a vocabulary file into a dictionary.&quot;&quot;&quot;</span>
    <span class="n">vocab</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
    <span class="n">fin</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">vocab_file</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">num</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fin</span><span class="p">):</span>
        <span class="n">items</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">items</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">else</span> <span class="n">num</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">vocab</span><span class="p">[</span><span class="n">token</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">vocab</span>


<span class="c1">#def convert_by_vocab(vocab, items):</span>
<span class="c1">#    &quot;&quot;&quot;Converts a sequence of [tokens|ids] using the vocab.&quot;&quot;&quot;</span>
<span class="c1">#    output = []</span>
<span class="c1">#    for item in items:</span>
<span class="c1">#        output.append(vocab[item])</span>
<span class="c1">#    return output</span>


<span class="k">def</span> <span class="nf">convert_tokens_to_ids</span><span class="p">(</span><span class="n">vocab</span><span class="p">,</span> <span class="n">tokens</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Converts a sequence of tokens into ids using the vocab.&quot;&quot;&quot;</span>
    <span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">:</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vocab</span><span class="p">[</span><span class="n">item</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">output</span>


<span class="k">class</span> <span class="nc">KBCDataReader</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; DataReader</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">vocab_path</span><span class="p">,</span>
                 <span class="n">data_path</span><span class="p">,</span>
                 <span class="n">max_seq_len</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                 <span class="n">batch_size</span><span class="o">=</span><span class="mi">4096</span><span class="p">,</span>
                 <span class="n">is_training</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">dev_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">epoch</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                 <span class="n">vocab_size</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span> <span class="o">=</span> <span class="n">load_vocab</span><span class="p">(</span><span class="n">vocab_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">vocab_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">)</span> <span class="o">==</span> <span class="n">vocab_size</span><span class="p">,</span> \
                <span class="s2">&quot;Assert Error! Input vocab_size(</span><span class="si">%d</span><span class="s2">) is not consistant with voab_file(</span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> \
                <span class="p">(</span><span class="n">vocab_size</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pad_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">[</span><span class="s2">&quot;[PAD]&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">[</span><span class="s2">&quot;[MASK]&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">max_seq_len</span> <span class="o">=</span> <span class="n">max_seq_len</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">is_training</span> <span class="o">=</span> <span class="n">is_training</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span> <span class="o">=</span> <span class="n">shuffle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dev_count</span> <span class="o">=</span> <span class="n">dev_count</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">=</span> <span class="n">epoch</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_training</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dev_count</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">examples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_example</span><span class="p">(</span><span class="n">data_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_instance</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">examples</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">current_epoch</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_instance_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="k">def</span> <span class="nf">get_progress</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;return current progress of traning data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_instance_index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_epoch</span>

    <span class="k">def</span> <span class="nf">line2tokens</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tokens</span>

    <span class="k">def</span> <span class="nf">read_example</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_file</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reads the input file into a list of examples.&quot;&quot;&quot;</span>
        <span class="n">examples</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">input_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">convert_to_unicode</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                <span class="n">tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">line2tokens</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_seq_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> \
                    <span class="s2">&quot;Expecting at most [max_seq_len + 1]=</span><span class="si">%d</span><span class="s2"> tokens each line, current tokens </span><span class="si">%d</span><span class="s2">&quot;</span> \
                    <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_seq_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">))</span>
                <span class="n">token_ids</span> <span class="o">=</span> <span class="n">convert_tokens_to_ids</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">,</span> <span class="n">tokens</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">token_ids</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">examples</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">RawExample</span><span class="p">(</span>
                        <span class="n">token_ids</span><span class="o">=</span><span class="n">token_ids</span><span class="p">,</span> <span class="n">mask_type</span><span class="o">=</span><span class="n">tokens</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
                <span class="c1"># if len(examples) &lt;= 10:</span>
                <span class="c1">#     logger.info(&quot;*** Example ***&quot;)</span>
                <span class="c1">#     logger.info(&quot;tokens: %s&quot; % &quot; &quot;.join([printable_text(x) for x in tokens]))</span>
                <span class="c1">#     logger.info(&quot;token_ids: %s&quot; % &quot; &quot;.join([str(x) for x in token_ids]))</span>
        <span class="k">return</span> <span class="n">examples</span>

    <span class="k">def</span> <span class="nf">data_generator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; wrap the batch data generator</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">range_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">total_instance</span><span class="p">)]</span>

        <span class="k">def</span> <span class="nf">wrapper</span><span class="p">():</span>
            <span class="sd">&quot;&quot;&quot; wrapper batch data</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="k">def</span> <span class="nf">reader</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">epoch_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">current_epoch</span> <span class="o">=</span> <span class="n">epoch_index</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">range_list</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">sample</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">range_list</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">current_instance_index</span> <span class="o">=</span> <span class="n">idx</span>
                        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">examples</span><span class="p">[</span><span class="n">sample</span><span class="p">]</span>

            <span class="k">def</span> <span class="nf">batch_reader</span><span class="p">(</span><span class="n">reader</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">):</span>
                <span class="sd">&quot;&quot;&quot;reader generator for batches of examples</span>
<span class="sd">                :param reader: reader generator for one example</span>
<span class="sd">                :param batch_size: int batch size</span>
<span class="sd">                :return: a list of examples for batch data</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="n">batch</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">example</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">():</span>
                    <span class="n">token_ids</span> <span class="o">=</span> <span class="n">example</span><span class="o">.</span><span class="n">token_ids</span>
                    <span class="n">mask_type</span> <span class="o">=</span> <span class="n">example</span><span class="o">.</span><span class="n">mask_type</span>
                    <span class="n">example_out</span> <span class="o">=</span> <span class="p">[</span><span class="n">token_ids</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">mask_type</span><span class="p">]</span>
                    <span class="n">to_append</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">batch_size</span>
                    <span class="k">if</span> <span class="n">to_append</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="n">batch</span>
                        <span class="n">batch</span> <span class="o">=</span> <span class="p">[</span><span class="n">example_out</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">example_out</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">batch</span>

            <span class="n">all_device_batches</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">batch_data</span> <span class="ow">in</span> <span class="n">batch_reader</span><span class="p">(</span><span class="n">reader</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">):</span>
                <span class="n">batch_data</span> <span class="o">=</span> <span class="n">prepare_batch_data</span><span class="p">(</span>
                    <span class="n">batch_data</span><span class="p">,</span>
                    <span class="n">max_len</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_seq_len</span><span class="p">,</span>
                    <span class="n">pad_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pad_id</span><span class="p">,</span>
                    <span class="n">mask_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mask_id</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_device_batches</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">dev_count</span><span class="p">:</span>
                    <span class="n">all_device_batches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">batch_data</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_device_batches</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">dev_count</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">all_device_batches</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="n">batch</span>
                    <span class="n">all_device_batches</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">return</span> <span class="n">wrapper</span>


<span class="k">class</span> <span class="nc">PathqueryDataReader</span><span class="p">(</span><span class="n">KBCDataReader</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">vocab_path</span><span class="p">,</span>
                 <span class="n">data_path</span><span class="p">,</span>
                 <span class="n">max_seq_len</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                 <span class="n">batch_size</span><span class="o">=</span><span class="mi">4096</span><span class="p">,</span>
                 <span class="n">is_training</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">dev_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">epoch</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                 <span class="n">vocab_size</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>

        <span class="n">KBCDataReader</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vocab_path</span><span class="p">,</span> <span class="n">data_path</span><span class="p">,</span> <span class="n">max_seq_len</span><span class="p">,</span>
                               <span class="n">batch_size</span><span class="p">,</span> <span class="n">is_training</span><span class="p">,</span> <span class="n">shuffle</span><span class="p">,</span> <span class="n">dev_count</span><span class="p">,</span>
                               <span class="n">epoch</span><span class="p">,</span> <span class="n">vocab_size</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">line2tokens</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">s</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">mask_type</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">path_tokens</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
        <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">tokens</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">path_tokens</span><span class="p">)</span>
        <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
        <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mask_type</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tokens</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">cast_fp32_to_fp16</span><span class="p">(</span><span class="n">exe</span><span class="p">,</span> <span class="n">main_program</span><span class="p">):</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Cast parameters to float16 data format.&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">main_program</span><span class="o">.</span><span class="n">global_block</span><span class="p">()</span><span class="o">.</span><span class="n">all_parameters</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.master&quot;</span><span class="p">):</span>
            <span class="n">param_t</span> <span class="o">=</span> <span class="n">fluid</span><span class="o">.</span><span class="n">global_scope</span><span class="p">()</span><span class="o">.</span><span class="n">find_var</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">get_tensor</span><span class="p">()</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">param_t</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;layer_norm&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">param_t</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float16</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">),</span> <span class="n">exe</span><span class="o">.</span><span class="n">place</span><span class="p">)</span>
            <span class="n">master_param_var</span> <span class="o">=</span> <span class="n">fluid</span><span class="o">.</span><span class="n">global_scope</span><span class="p">()</span><span class="o">.</span><span class="n">find_var</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span>
                                                             <span class="s2">&quot;.master&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">master_param_var</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">master_param_var</span><span class="o">.</span><span class="n">get_tensor</span><span class="p">()</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">exe</span><span class="o">.</span><span class="n">place</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">init_checkpoint</span><span class="p">(</span><span class="n">exe</span><span class="p">,</span>
                    <span class="n">init_checkpoint_path</span><span class="p">,</span>
                    <span class="n">main_program</span><span class="p">,</span>
                    <span class="n">use_fp16</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">print_var_verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span>
        <span class="n">init_checkpoint_path</span><span class="p">),</span> <span class="s2">&quot;[</span><span class="si">%s</span><span class="s2">] cann&#39;t be found.&quot;</span> <span class="o">%</span> <span class="n">init_checkpoint_path</span>

    <span class="k">def</span> <span class="nf">existed_persitables</span><span class="p">(</span><span class="n">var</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fluid</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">is_persistable</span><span class="p">(</span><span class="n">var</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">init_checkpoint_path</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

    <span class="n">fluid</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">load_vars</span><span class="p">(</span>
        <span class="n">exe</span><span class="p">,</span>
        <span class="n">init_checkpoint_path</span><span class="p">,</span>
        <span class="n">main_program</span><span class="o">=</span><span class="n">main_program</span><span class="p">,</span>
        <span class="n">predicate</span><span class="o">=</span><span class="n">existed_persitables</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Load model from </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">init_checkpoint_path</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">use_fp16</span><span class="p">:</span>
        <span class="n">cast_fp32_to_fp16</span><span class="p">(</span><span class="n">exe</span><span class="p">,</span> <span class="n">main_program</span><span class="p">)</span>

    <span class="c1"># Used for debug on parameters</span>
    <span class="k">if</span> <span class="n">print_var_verbose</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>

        <span class="k">def</span> <span class="nf">params</span><span class="p">(</span><span class="n">var</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">fluid</span><span class="o">.</span><span class="n">framework</span><span class="o">.</span><span class="n">Parameter</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="n">existed_vars</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">main_program</span><span class="o">.</span><span class="n">list_vars</span><span class="p">()))</span>
        <span class="n">existed_vars</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">existed_vars</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">existed_vars</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;var name:</span><span class="si">{}</span><span class="s2"> shape:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">init_pretraining_params</span><span class="p">(</span><span class="n">exe</span><span class="p">,</span>
                            <span class="n">pretraining_params_path</span><span class="p">,</span>
                            <span class="n">main_program</span><span class="p">,</span>
                            <span class="n">use_fp16</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pretraining_params_path</span>
                          <span class="p">),</span> <span class="s2">&quot;[</span><span class="si">%s</span><span class="s2">] cann&#39;t be found.&quot;</span> <span class="o">%</span> <span class="n">pretraining_params_path</span>

    <span class="k">def</span> <span class="nf">existed_params</span><span class="p">(</span><span class="n">var</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">fluid</span><span class="o">.</span><span class="n">framework</span><span class="o">.</span><span class="n">Parameter</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pretraining_params_path</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

    <span class="n">fluid</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">load_vars</span><span class="p">(</span>
        <span class="n">exe</span><span class="p">,</span>
        <span class="n">pretraining_params_path</span><span class="p">,</span>
        <span class="n">main_program</span><span class="o">=</span><span class="n">main_program</span><span class="p">,</span>
        <span class="n">predicate</span><span class="o">=</span><span class="n">existed_params</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Load pretraining parameters from </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">pretraining_params_path</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">use_fp16</span><span class="p">:</span>
        <span class="n">cast_fp32_to_fp16</span><span class="p">(</span><span class="n">exe</span><span class="p">,</span> <span class="n">main_program</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">CoKEModel</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">src_ids</span><span class="p">,</span>
                 <span class="n">position_ids</span><span class="p">,</span>
                 <span class="n">input_mask</span><span class="p">,</span>
                 <span class="n">config</span><span class="p">,</span>
                 <span class="n">soft_label</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span>
                 <span class="n">weight_sharing</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">use_fp16</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_emb_size</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;hidden_size&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_n_layer</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;num_hidden_layers&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_n_head</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;num_attention_heads&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_voc_size</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;vocab_size&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_n_relation</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;num_relations&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_max_position_seq_len</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;max_position_embeddings&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hidden_act</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;hidden_act&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prepostprocess_dropout</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;hidden_dropout_prob&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_attention_dropout</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;attention_probs_dropout_prob&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_intermediate_size</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;intermediate_size&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_soft_label</span> <span class="o">=</span> <span class="n">soft_label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_weight_sharing</span> <span class="o">=</span> <span class="n">weight_sharing</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_word_emb_name</span> <span class="o">=</span> <span class="s2">&quot;word_embedding&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pos_emb_name</span> <span class="o">=</span> <span class="s2">&quot;pos_embedding&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dtype</span> <span class="o">=</span> <span class="s2">&quot;float16&quot;</span> <span class="k">if</span> <span class="n">use_fp16</span> <span class="k">else</span> <span class="s2">&quot;float32&quot;</span>

        <span class="c1"># Initialize all weigths by truncated normal initializer, and all biases</span>
        <span class="c1"># will be initialized by constant zero by default.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_param_initializer</span> <span class="o">=</span> <span class="n">fluid</span><span class="o">.</span><span class="n">initializer</span><span class="o">.</span><span class="n">TruncatedNormal</span><span class="p">(</span>
            <span class="n">scale</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;initializer_range&#39;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_build_model</span><span class="p">(</span><span class="n">src_ids</span><span class="p">,</span> <span class="n">position_ids</span><span class="p">,</span> <span class="n">input_mask</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_build_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src_ids</span><span class="p">,</span> <span class="n">position_ids</span><span class="p">,</span> <span class="n">input_mask</span><span class="p">):</span>
        <span class="c1"># padding id in vocabulary must be set to 0</span>
        <span class="n">emb_out</span> <span class="o">=</span> <span class="n">fluid</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">embedding</span><span class="p">(</span>
            <span class="nb">input</span><span class="o">=</span><span class="n">src_ids</span><span class="p">,</span>
            <span class="n">size</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_voc_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_emb_size</span><span class="p">],</span>
            <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dtype</span><span class="p">,</span>
            <span class="n">param_attr</span><span class="o">=</span><span class="n">fluid</span><span class="o">.</span><span class="n">ParamAttr</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_word_emb_name</span><span class="p">,</span> <span class="n">initializer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_param_initializer</span><span class="p">),</span>
            <span class="n">is_sparse</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">position_emb_out</span> <span class="o">=</span> <span class="n">fluid</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">embedding</span><span class="p">(</span>
            <span class="nb">input</span><span class="o">=</span><span class="n">position_ids</span><span class="p">,</span>
            <span class="n">size</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_max_position_seq_len</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_emb_size</span><span class="p">],</span>
            <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dtype</span><span class="p">,</span>
            <span class="n">param_attr</span><span class="o">=</span><span class="n">fluid</span><span class="o">.</span><span class="n">ParamAttr</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_pos_emb_name</span><span class="p">,</span> <span class="n">initializer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_param_initializer</span><span class="p">))</span>

        <span class="n">emb_out</span> <span class="o">=</span> <span class="n">emb_out</span> <span class="o">+</span> <span class="n">position_emb_out</span>

        <span class="n">emb_out</span> <span class="o">=</span> <span class="n">pre_process_layer</span><span class="p">(</span>
            <span class="n">emb_out</span><span class="p">,</span> <span class="s1">&#39;nd&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepostprocess_dropout</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;pre_encoder&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dtype</span> <span class="o">==</span> <span class="s2">&quot;float16&quot;</span><span class="p">:</span>
            <span class="n">input_mask</span> <span class="o">=</span> <span class="n">fluid</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">input_mask</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dtype</span><span class="p">)</span>

        <span class="n">self_attn_mask</span> <span class="o">=</span> <span class="n">fluid</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">input_mask</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">input_mask</span><span class="p">,</span> <span class="n">transpose_y</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">self_attn_mask</span> <span class="o">=</span> <span class="n">fluid</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">self_attn_mask</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">10000.0</span><span class="p">,</span> <span class="n">bias</span><span class="o">=-</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">bias_after_scale</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">n_head_self_attn_mask</span> <span class="o">=</span> <span class="n">fluid</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="n">self_attn_mask</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_head</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">n_head_self_attn_mask</span><span class="o">.</span><span class="n">stop_gradient</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_enc_out</span> <span class="o">=</span> <span class="n">encoder</span><span class="p">(</span>
            <span class="n">enc_input</span><span class="o">=</span><span class="n">emb_out</span><span class="p">,</span>
            <span class="n">attn_bias</span><span class="o">=</span><span class="n">n_head_self_attn_mask</span><span class="p">,</span>
            <span class="n">n_layer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_layer</span><span class="p">,</span>
            <span class="n">n_head</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_head</span><span class="p">,</span>
            <span class="n">d_key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_emb_size</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_head</span><span class="p">,</span>
            <span class="n">d_value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_emb_size</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_head</span><span class="p">,</span>
            <span class="n">d_model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_emb_size</span><span class="p">,</span>
            <span class="n">d_inner_hid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_intermediate_size</span><span class="p">,</span>
            <span class="n">prepostprocess_dropout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_prepostprocess_dropout</span><span class="p">,</span>
            <span class="n">attention_dropout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_attention_dropout</span><span class="p">,</span>
            <span class="n">relu_dropout</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">hidden_act</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_hidden_act</span><span class="p">,</span>
            <span class="n">preprocess_cmd</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">postprocess_cmd</span><span class="o">=</span><span class="s2">&quot;dan&quot;</span><span class="p">,</span>
            <span class="n">param_initializer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_param_initializer</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;encoder&#39;</span><span class="p">)</span>

    <span class="c1">#def get_sequence_output(self):</span>
    <span class="c1">#    return self._enc_out</span>

    <span class="k">def</span> <span class="nf">get_pretraining_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask_label</span><span class="p">,</span> <span class="n">mask_pos</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the loss &amp; fc_out for training&quot;&quot;&quot;</span>
        <span class="n">mask_pos</span> <span class="o">=</span> <span class="n">fluid</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">mask_pos</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">)</span>

        <span class="n">reshaped_emb_out</span> <span class="o">=</span> <span class="n">fluid</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_enc_out</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_emb_size</span><span class="p">])</span>
        <span class="c1"># extract masked tokens&#39; feature</span>
        <span class="n">mask_feat</span> <span class="o">=</span> <span class="n">fluid</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">reshaped_emb_out</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">mask_pos</span><span class="p">)</span>

        <span class="c1"># transform: fc</span>
        <span class="n">mask_trans_feat</span> <span class="o">=</span> <span class="n">fluid</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">fc</span><span class="p">(</span>
            <span class="nb">input</span><span class="o">=</span><span class="n">mask_feat</span><span class="p">,</span>
            <span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_emb_size</span><span class="p">,</span>
            <span class="n">act</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_hidden_act</span><span class="p">,</span>
            <span class="n">param_attr</span><span class="o">=</span><span class="n">fluid</span><span class="o">.</span><span class="n">ParamAttr</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;mask_lm_trans_fc.w_0&#39;</span><span class="p">,</span>
                <span class="n">initializer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_param_initializer</span><span class="p">),</span>
            <span class="n">bias_attr</span><span class="o">=</span><span class="n">fluid</span><span class="o">.</span><span class="n">ParamAttr</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;mask_lm_trans_fc.b_0&#39;</span><span class="p">))</span>
        <span class="c1"># transform: layer norm</span>
        <span class="n">mask_trans_feat</span> <span class="o">=</span> <span class="n">pre_process_layer</span><span class="p">(</span>
            <span class="n">mask_trans_feat</span><span class="p">,</span> <span class="s1">&#39;n&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;mask_lm_trans&#39;</span><span class="p">)</span>

        <span class="n">mask_lm_out_bias_attr</span> <span class="o">=</span> <span class="n">fluid</span><span class="o">.</span><span class="n">ParamAttr</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;mask_lm_out_fc.b_0&quot;</span><span class="p">,</span>
            <span class="n">initializer</span><span class="o">=</span><span class="n">fluid</span><span class="o">.</span><span class="n">initializer</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mf">0.0</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_weight_sharing</span><span class="p">:</span>
            <span class="n">fc_out</span> <span class="o">=</span> <span class="n">fluid</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="n">mask_trans_feat</span><span class="p">,</span>
                <span class="n">y</span><span class="o">=</span><span class="n">fluid</span><span class="o">.</span><span class="n">default_main_program</span><span class="p">()</span><span class="o">.</span><span class="n">global_block</span><span class="p">()</span><span class="o">.</span><span class="n">var</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_word_emb_name</span><span class="p">),</span>
                <span class="n">transpose_y</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">fc_out</span> <span class="o">+=</span> <span class="n">fluid</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">create_parameter</span><span class="p">(</span>
                <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_voc_size</span><span class="p">],</span>
                <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dtype</span><span class="p">,</span>
                <span class="n">attr</span><span class="o">=</span><span class="n">mask_lm_out_bias_attr</span><span class="p">,</span>
                <span class="n">is_bias</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fc_out</span> <span class="o">=</span> <span class="n">fluid</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">fc</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">mask_trans_feat</span><span class="p">,</span>
                                     <span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_voc_size</span><span class="p">,</span>
                                     <span class="n">param_attr</span><span class="o">=</span><span class="n">fluid</span><span class="o">.</span><span class="n">ParamAttr</span><span class="p">(</span>
                                         <span class="n">name</span><span class="o">=</span><span class="s2">&quot;mask_lm_out_fc.w_0&quot;</span><span class="p">,</span>
                                         <span class="n">initializer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_param_initializer</span><span class="p">),</span>
                                     <span class="n">bias_attr</span><span class="o">=</span><span class="n">mask_lm_out_bias_attr</span><span class="p">)</span>
        <span class="c1">#generate soft labels for loss cross entropy loss</span>
        <span class="n">one_hot_labels</span> <span class="o">=</span> <span class="n">fluid</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">one_hot</span><span class="p">(</span>
            <span class="nb">input</span><span class="o">=</span><span class="n">mask_label</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_voc_size</span><span class="p">)</span>
        <span class="n">entity_indicator</span> <span class="o">=</span> <span class="n">fluid</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">fill_constant_batch_size_like</span><span class="p">(</span>
            <span class="nb">input</span><span class="o">=</span><span class="n">mask_label</span><span class="p">,</span>
            <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_voc_size</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_relation</span><span class="p">)],</span>
            <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int64&#39;</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">relation_indicator</span> <span class="o">=</span> <span class="n">fluid</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">fill_constant_batch_size_like</span><span class="p">(</span>
            <span class="nb">input</span><span class="o">=</span><span class="n">mask_label</span><span class="p">,</span>
            <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_relation</span><span class="p">],</span>
            <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int64&#39;</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">is_relation</span> <span class="o">=</span> <span class="n">fluid</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
            <span class="nb">input</span><span class="o">=</span><span class="p">[</span><span class="n">entity_indicator</span><span class="p">,</span> <span class="n">relation_indicator</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">soft_labels</span> <span class="o">=</span> <span class="n">one_hot_labels</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_soft_label</span> \
                      <span class="o">+</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">one_hot_labels</span> <span class="o">-</span> <span class="n">is_relation</span><span class="p">)</span> \
                      <span class="o">*</span> <span class="p">((</span><span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_soft_label</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_voc_size</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_relation</span><span class="p">))</span>
        <span class="n">soft_labels</span><span class="o">.</span><span class="n">stop_gradient</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">mask_lm_loss</span> <span class="o">=</span> <span class="n">fluid</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">softmax_with_cross_entropy</span><span class="p">(</span>
            <span class="n">logits</span><span class="o">=</span><span class="n">fc_out</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">soft_labels</span><span class="p">,</span> <span class="n">soft_label</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">mean_mask_lm_loss</span> <span class="o">=</span> <span class="n">fluid</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">mask_lm_loss</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">mean_mask_lm_loss</span><span class="p">,</span> <span class="n">fc_out</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">kbc_batch_evaluation</span><span class="p">(</span><span class="n">eval_i</span><span class="p">,</span> <span class="n">all_examples</span><span class="p">,</span> <span class="n">batch_results</span><span class="p">,</span> <span class="n">tt</span><span class="p">):</span>
    <span class="n">r_hts_idx</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">scores_head</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">scores_tail</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">batch_r_hts_cnt</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">b_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch_results</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">b_size</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">batch_results</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">eval_i</span> <span class="o">+</span> <span class="n">j</span>
        <span class="n">example</span> <span class="o">=</span> <span class="n">all_examples</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">example</span><span class="o">.</span><span class="n">token_ids</span>
                   <span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;For kbc task each example consists of 3 tokens&quot;</span>
        <span class="n">h</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">example</span><span class="o">.</span><span class="n">token_ids</span>

        <span class="n">_mask_type</span> <span class="o">=</span> <span class="n">example</span><span class="o">.</span><span class="n">mask_type</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">r_hts_idx</span><span class="p">[</span><span class="n">r</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">h</span><span class="p">,</span> <span class="n">t</span><span class="p">))</span>
            <span class="n">batch_r_hts_cnt</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">_mask_type</span> <span class="o">==</span> <span class="s2">&quot;MASK_HEAD&quot;</span><span class="p">:</span>
            <span class="n">scores_head</span><span class="p">[(</span><span class="n">r</span><span class="p">,</span> <span class="n">t</span><span class="p">)]</span> <span class="o">=</span> <span class="n">result</span>
        <span class="k">elif</span> <span class="n">_mask_type</span> <span class="o">==</span> <span class="s2">&quot;MASK_TAIL&quot;</span><span class="p">:</span>
            <span class="n">scores_tail</span><span class="p">[(</span><span class="n">r</span><span class="p">,</span> <span class="n">h</span><span class="p">)]</span> <span class="o">=</span> <span class="n">result</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown mask type in prediction example:</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>

    <span class="n">rank</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">f_rank</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">r</span><span class="p">,</span> <span class="n">hts</span> <span class="ow">in</span> <span class="n">r_hts_idx</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">r_rank</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;head&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;tail&#39;</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="n">r_f_rank</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;head&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;tail&#39;</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="k">for</span> <span class="n">h</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">hts</span><span class="p">:</span>
            <span class="n">scores_t</span> <span class="o">=</span> <span class="n">scores_tail</span><span class="p">[(</span><span class="n">r</span><span class="p">,</span> <span class="n">h</span><span class="p">)][:]</span>
            <span class="n">sortidx_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">scores_t</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">r_rank</span><span class="p">[</span><span class="s1">&#39;tail&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sortidx_t</span> <span class="o">==</span> <span class="n">t</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

            <span class="n">rm_idx</span> <span class="o">=</span> <span class="n">tt</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="s1">&#39;ts&#39;</span><span class="p">][</span><span class="n">h</span><span class="p">]</span>
            <span class="n">rm_idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">rm_idx</span> <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">t</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">rm_idx</span><span class="p">:</span>
                <span class="n">scores_t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">Inf</span>
            <span class="n">sortidx_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">scores_t</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">r_f_rank</span><span class="p">[</span><span class="s1">&#39;tail&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sortidx_t</span> <span class="o">==</span> <span class="n">t</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

            <span class="n">scores_h</span> <span class="o">=</span> <span class="n">scores_head</span><span class="p">[(</span><span class="n">r</span><span class="p">,</span> <span class="n">t</span><span class="p">)][:]</span>
            <span class="n">sortidx_h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">scores_h</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">r_rank</span><span class="p">[</span><span class="s1">&#39;head&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sortidx_h</span> <span class="o">==</span> <span class="n">h</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

            <span class="n">rm_idx</span> <span class="o">=</span> <span class="n">tt</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="s1">&#39;hs&#39;</span><span class="p">][</span><span class="n">t</span><span class="p">]</span>
            <span class="n">rm_idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">rm_idx</span> <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">h</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">rm_idx</span><span class="p">:</span>
                <span class="n">scores_h</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">Inf</span>
            <span class="n">sortidx_h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">scores_h</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">r_f_rank</span><span class="p">[</span><span class="s1">&#39;head&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sortidx_h</span> <span class="o">==</span> <span class="n">h</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">rank</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">=</span> <span class="n">r_rank</span>
        <span class="n">f_rank</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">=</span> <span class="n">r_f_rank</span>

    <span class="n">h_pos</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">rank</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">rank</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;head&#39;</span><span class="p">]]</span>
    <span class="n">t_pos</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">rank</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">rank</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;tail&#39;</span><span class="p">]]</span>
    <span class="n">f_h_pos</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">f_rank</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">f_rank</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;head&#39;</span><span class="p">]]</span>
    <span class="n">f_t_pos</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">f_rank</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">f_rank</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;tail&#39;</span><span class="p">]]</span>

    <span class="n">ranks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">h_pos</span> <span class="o">+</span> <span class="n">t_pos</span><span class="p">)</span>
    <span class="n">f_ranks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">f_h_pos</span> <span class="o">+</span> <span class="n">f_t_pos</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ranks</span><span class="p">,</span> <span class="n">f_ranks</span>


<span class="k">def</span> <span class="nf">pathquery_batch_evaluation</span><span class="p">(</span><span class="n">eval_i</span><span class="p">,</span> <span class="n">all_examples</span><span class="p">,</span> <span class="n">batch_results</span><span class="p">,</span>
                               <span class="n">sen_negli_dict</span><span class="p">,</span> <span class="n">trivial_sen_set</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; evaluate the metrics for batch datas for pathquery datasets &quot;&quot;&quot;</span>
    <span class="n">mqs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ranks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">batch_results</span><span class="p">):</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">eval_i</span> <span class="o">+</span> <span class="n">j</span>
        <span class="n">example</span> <span class="o">=</span> <span class="n">all_examples</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">token_ids</span><span class="p">,</span> <span class="n">mask_type</span> <span class="o">=</span> <span class="n">example</span>
        <span class="k">assert</span> <span class="n">mask_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;MASK_TAIL&quot;</span><span class="p">,</span> <span class="s2">&quot;MASK_HEAD&quot;</span>
                             <span class="p">],</span> <span class="s2">&quot; Unknown mask type in pathquery evaluation&quot;</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">token_ids</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">mask_type</span> <span class="o">==</span> <span class="s2">&quot;MASK_TAIL&quot;</span> <span class="k">else</span> <span class="n">token_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">sen</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">token_ids</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">sen</span> <span class="ow">in</span> <span class="n">trivial_sen_set</span><span class="p">:</span>
            <span class="n">mq</span> <span class="o">=</span> <span class="n">rank</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># candidate vocab set</span>
            <span class="n">cand_set</span> <span class="o">=</span> <span class="n">sen_negli_dict</span><span class="p">[</span><span class="n">sen</span><span class="p">]</span>
            <span class="k">assert</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span>
                <span class="n">cand_set</span><span class="p">),</span> <span class="s2">&quot;predict label must be in the candidate set&quot;</span>

            <span class="n">cand_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cand_set</span><span class="p">))</span>
            <span class="n">cand_ret</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span>
                <span class="n">cand_idx</span><span class="p">]</span>  <span class="c1">#logits for candidate words(neg + gold words)</span>
            <span class="n">cand_ranks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">cand_ret</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">pred_y</span> <span class="o">=</span> <span class="n">cand_idx</span><span class="p">[</span><span class="n">cand_ranks</span><span class="p">]</span>

            <span class="n">rank</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">pred_y</span> <span class="o">==</span> <span class="n">label</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">mq</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cand_set</span><span class="p">)</span> <span class="o">-</span> <span class="n">rank</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cand_set</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="n">mqs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mq</span><span class="p">)</span>
        <span class="n">ranks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rank</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mqs</span><span class="p">,</span> <span class="n">ranks</span>


<span class="k">def</span> <span class="nf">compute_kbc_metrics</span><span class="p">(</span><span class="n">rank_li</span><span class="p">,</span> <span class="n">frank_li</span><span class="p">,</span> <span class="n">output_evaluation_result_file</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; combine the kbc rank results from batches into the final metrics &quot;&quot;&quot;</span>
    <span class="n">rank_rets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rank_li</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
    <span class="n">frank_rets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">frank_li</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
    <span class="n">mrr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">rank_rets</span><span class="p">)</span>
    <span class="n">fmrr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">frank_rets</span><span class="p">)</span>

    <span class="n">hits1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">rank_rets</span> <span class="o">&lt;=</span> <span class="mf">1.0</span><span class="p">)</span>
    <span class="n">hits3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">rank_rets</span> <span class="o">&lt;=</span> <span class="mf">3.0</span><span class="p">)</span>
    <span class="n">hits10</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">rank_rets</span> <span class="o">&lt;=</span> <span class="mf">10.0</span><span class="p">)</span>
    <span class="c1"># filtered metrics</span>
    <span class="n">fhits1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">frank_rets</span> <span class="o">&lt;=</span> <span class="mf">1.0</span><span class="p">)</span>
    <span class="n">fhits3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">frank_rets</span> <span class="o">&lt;=</span> <span class="mf">3.0</span><span class="p">)</span>
    <span class="n">fhits10</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">frank_rets</span> <span class="o">&lt;=</span> <span class="mf">10.0</span><span class="p">)</span>

    <span class="n">eval_result</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;mrr&#39;</span><span class="p">:</span> <span class="n">mrr</span><span class="p">,</span>
        <span class="s1">&#39;hits1&#39;</span><span class="p">:</span> <span class="n">hits1</span><span class="p">,</span>
        <span class="s1">&#39;hits3&#39;</span><span class="p">:</span> <span class="n">hits3</span><span class="p">,</span>
        <span class="s1">&#39;hits10&#39;</span><span class="p">:</span> <span class="n">hits10</span><span class="p">,</span>
        <span class="s1">&#39;fmrr&#39;</span><span class="p">:</span> <span class="n">fmrr</span><span class="p">,</span>
        <span class="s1">&#39;fhits1&#39;</span><span class="p">:</span> <span class="n">fhits1</span><span class="p">,</span>
        <span class="s1">&#39;fhits3&#39;</span><span class="p">:</span> <span class="n">fhits3</span><span class="p">,</span>
        <span class="s1">&#39;fhits10&#39;</span><span class="p">:</span> <span class="n">fhits10</span>
    <span class="p">}</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_evaluation_result_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fw</span><span class="p">:</span>
        <span class="n">fw</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">eval_result</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">eval_result</span>


<span class="k">def</span> <span class="nf">compute_pathquery_metrics</span><span class="p">(</span><span class="n">mq_li</span><span class="p">,</span> <span class="n">rank_li</span><span class="p">,</span> <span class="n">output_evaluation_result_file</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; combine the pathquery mq, rank results from batches into the final metrics &quot;&quot;&quot;</span>
    <span class="n">rank_rets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rank_li</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
    <span class="n">_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">rank_rets</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">non_trivial_eval_rets</span> <span class="o">=</span> <span class="n">rank_rets</span><span class="p">[</span><span class="n">_idx</span><span class="p">]</span>
    <span class="n">non_trivial_mq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mq_li</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[</span><span class="n">_idx</span><span class="p">]</span>
    <span class="n">non_trivial_cnt</span> <span class="o">=</span> <span class="n">non_trivial_eval_rets</span><span class="o">.</span><span class="n">size</span>

    <span class="n">mq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">non_trivial_mq</span><span class="p">)</span>
    <span class="n">mr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">non_trivial_eval_rets</span><span class="p">)</span>
    <span class="n">mrr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">non_trivial_eval_rets</span><span class="p">)</span>
    <span class="n">fhits10</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">non_trivial_eval_rets</span> <span class="o">&lt;=</span> <span class="mf">10.0</span><span class="p">)</span>

    <span class="n">eval_result</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;fcnt&#39;</span><span class="p">:</span> <span class="n">non_trivial_cnt</span><span class="p">,</span>
        <span class="s1">&#39;mq&#39;</span><span class="p">:</span> <span class="n">mq</span><span class="p">,</span>
        <span class="s1">&#39;mr&#39;</span><span class="p">:</span> <span class="n">mr</span><span class="p">,</span>
        <span class="s1">&#39;fhits10&#39;</span><span class="p">:</span> <span class="n">fhits10</span>
    <span class="p">}</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_evaluation_result_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fw</span><span class="p">:</span>
        <span class="n">fw</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">eval_result</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">eval_result</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">linear_warmup_decay</span><span class="p">(</span><span class="n">learning_rate</span><span class="p">,</span> <span class="n">warmup_steps</span><span class="p">,</span> <span class="n">num_train_steps</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Applies linear warmup of learning rate from 0 and decay to 0.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">fluid</span><span class="o">.</span><span class="n">default_main_program</span><span class="p">()</span><span class="o">.</span><span class="n">_lr_schedule_guard</span><span class="p">():</span>
        <span class="n">lr</span> <span class="o">=</span> <span class="n">fluid</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">tensor</span><span class="o">.</span><span class="n">create_global_var</span><span class="p">(</span>
            <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">value</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">,</span>
            <span class="n">persistable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;scheduled_learning_rate&quot;</span><span class="p">)</span>

        <span class="n">global_step</span> <span class="o">=</span> <span class="n">fluid</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">learning_rate_scheduler</span><span class="o">.</span><span class="n">_decay_step_counter</span><span class="p">(</span>
        <span class="p">)</span>

        <span class="k">with</span> <span class="n">fluid</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">control_flow</span><span class="o">.</span><span class="n">Switch</span><span class="p">()</span> <span class="k">as</span> <span class="n">switch</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">switch</span><span class="o">.</span><span class="n">case</span><span class="p">(</span><span class="n">global_step</span> <span class="o">&lt;</span> <span class="n">num_train_steps</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">):</span>
                <span class="n">warmup_lr</span> <span class="o">=</span> <span class="n">learning_rate</span> <span class="o">*</span> <span class="p">(</span><span class="n">global_step</span> <span class="o">/</span>
                                             <span class="p">(</span><span class="n">num_train_steps</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">))</span>
                <span class="n">fluid</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">tensor</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">warmup_lr</span><span class="p">,</span> <span class="n">lr</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">switch</span><span class="o">.</span><span class="n">default</span><span class="p">():</span>
                <span class="n">decayed_lr</span> <span class="o">=</span> <span class="n">fluid</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">learning_rate_scheduler</span><span class="o">.</span><span class="n">polynomial_decay</span><span class="p">(</span>
                    <span class="n">learning_rate</span><span class="o">=</span><span class="n">learning_rate</span><span class="p">,</span>
                    <span class="n">decay_steps</span><span class="o">=</span><span class="n">num_train_steps</span><span class="p">,</span>
                    <span class="n">end_learning_rate</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                    <span class="n">power</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                    <span class="n">cycle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">fluid</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">tensor</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">decayed_lr</span><span class="p">,</span> <span class="n">lr</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">lr</span>


<span class="k">def</span> <span class="nf">optimization</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span>
                 <span class="n">warmup_steps</span><span class="p">,</span>
                 <span class="n">num_train_steps</span><span class="p">,</span>
                 <span class="n">learning_rate</span><span class="p">,</span>
                 <span class="n">train_program</span><span class="p">,</span>
                 <span class="n">startup_prog</span><span class="p">,</span>
                 <span class="n">weight_decay</span><span class="p">,</span>
                 <span class="n">scheduler</span><span class="o">=</span><span class="s1">&#39;linear_warmup_decay&#39;</span><span class="p">,</span>
                 <span class="n">use_fp16</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">loss_scaling</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">warmup_steps</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">scheduler</span> <span class="o">==</span> <span class="s1">&#39;noam_decay&#39;</span><span class="p">:</span>
            <span class="n">scheduled_lr</span> <span class="o">=</span> <span class="n">fluid</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">learning_rate_scheduler</span>\
             <span class="o">.</span><span class="n">noam_decay</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">warmup_steps</span> <span class="o">*</span><span class="p">(</span><span class="n">learning_rate</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)),</span>
                         <span class="n">warmup_steps</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">scheduler</span> <span class="o">==</span> <span class="s1">&#39;linear_warmup_decay&#39;</span><span class="p">:</span>
            <span class="n">scheduled_lr</span> <span class="o">=</span> <span class="n">linear_warmup_decay</span><span class="p">(</span><span class="n">learning_rate</span><span class="p">,</span> <span class="n">warmup_steps</span><span class="p">,</span>
                                               <span class="n">num_train_steps</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unkown learning rate scheduler, should be &quot;</span>
                             <span class="s2">&quot;&#39;noam_decay&#39; or &#39;linear_warmup_decay&#39;&quot;</span><span class="p">)</span>
        <span class="n">optimizer</span> <span class="o">=</span> <span class="n">fluid</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span>
            <span class="n">learning_rate</span><span class="o">=</span><span class="n">scheduled_lr</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">optimizer</span> <span class="o">=</span> <span class="n">fluid</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span>
            <span class="n">learning_rate</span><span class="o">=</span><span class="n">learning_rate</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)</span>
        <span class="n">scheduled_lr</span> <span class="o">=</span> <span class="n">learning_rate</span>

    <span class="n">clip_norm_thres</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="c1"># When using mixed precision training, scale the gradient clip threshold</span>
    <span class="c1"># by loss_scaling</span>
    <span class="k">if</span> <span class="n">use_fp16</span> <span class="ow">and</span> <span class="n">loss_scaling</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span>
        <span class="n">clip_norm_thres</span> <span class="o">*=</span> <span class="n">loss_scaling</span>
    <span class="n">fluid</span><span class="o">.</span><span class="n">clip</span><span class="o">.</span><span class="n">set_gradient_clip</span><span class="p">(</span>
        <span class="n">clip</span><span class="o">=</span><span class="n">fluid</span><span class="o">.</span><span class="n">clip</span><span class="o">.</span><span class="n">GradientClipByGlobalNorm</span><span class="p">(</span><span class="n">clip_norm</span><span class="o">=</span><span class="n">clip_norm_thres</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">exclude_from_weight_decay</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;layer_norm&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="n">bias_suffix</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;_bias&quot;</span><span class="p">,</span> <span class="s2">&quot;_b&quot;</span><span class="p">,</span> <span class="s2">&quot;.b_0&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="n">bias_suffix</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">suffix</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="n">param_list</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">use_fp16</span><span class="p">:</span>
        <span class="n">param_grads</span> <span class="o">=</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">backward</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
        <span class="n">master_param_grads</span> <span class="o">=</span> <span class="n">create_master_params_grads</span><span class="p">(</span>
            <span class="n">param_grads</span><span class="p">,</span> <span class="n">train_program</span><span class="p">,</span> <span class="n">startup_prog</span><span class="p">,</span> <span class="n">loss_scaling</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">master_param_grads</span><span class="p">:</span>
            <span class="n">param_list</span><span class="p">[</span><span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">param</span> <span class="o">*</span> <span class="mf">1.0</span>
            <span class="n">param_list</span><span class="p">[</span><span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">stop_gradient</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">optimizer</span><span class="o">.</span><span class="n">apply_gradients</span><span class="p">(</span><span class="n">master_param_grads</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">weight_decay</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">grad</span> <span class="ow">in</span> <span class="n">master_param_grads</span><span class="p">:</span>
                <span class="c1"># if exclude_from_weight_decay(param.name.rstrip(&quot;.master&quot;)):</span>
                <span class="c1">#     continue</span>
                <span class="k">with</span> <span class="n">param</span><span class="o">.</span><span class="n">block</span><span class="o">.</span><span class="n">program</span><span class="o">.</span><span class="n">_optimized_guard</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">param</span><span class="p">,</span> <span class="n">grad</span><span class="p">]),</span> <span class="n">fluid</span><span class="o">.</span><span class="n">framework</span><span class="o">.</span><span class="n">name_scope</span><span class="p">(</span><span class="s2">&quot;weight_decay&quot;</span><span class="p">):</span>
                    <span class="n">updated_param</span> <span class="o">=</span> <span class="n">param</span> <span class="o">-</span> <span class="n">param_list</span><span class="p">[</span>
                        <span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">*</span> <span class="n">weight_decay</span> <span class="o">*</span> <span class="n">scheduled_lr</span>
                    <span class="n">fluid</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="n">param</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="n">updated_param</span><span class="p">)</span>

        <span class="n">master_param_to_train_param</span><span class="p">(</span><span class="n">master_param_grads</span><span class="p">,</span> <span class="n">param_grads</span><span class="p">,</span>
                                    <span class="n">train_program</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">train_program</span><span class="o">.</span><span class="n">global_block</span><span class="p">()</span><span class="o">.</span><span class="n">all_parameters</span><span class="p">():</span>
            <span class="n">param_list</span><span class="p">[</span><span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">param</span> <span class="o">*</span> <span class="mf">1.0</span>
            <span class="n">param_list</span><span class="p">[</span><span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">stop_gradient</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">_</span><span class="p">,</span> <span class="n">param_grads</span> <span class="o">=</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">weight_decay</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">grad</span> <span class="ow">in</span> <span class="n">param_grads</span><span class="p">:</span>
                <span class="c1"># if exclude_from_weight_decay(param.name):</span>
                <span class="c1">#     continue</span>
                <span class="k">with</span> <span class="n">param</span><span class="o">.</span><span class="n">block</span><span class="o">.</span><span class="n">program</span><span class="o">.</span><span class="n">_optimized_guard</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">param</span><span class="p">,</span> <span class="n">grad</span><span class="p">]),</span> <span class="n">fluid</span><span class="o">.</span><span class="n">framework</span><span class="o">.</span><span class="n">name_scope</span><span class="p">(</span><span class="s2">&quot;weight_decay&quot;</span><span class="p">):</span>
                    <span class="n">updated_param</span> <span class="o">=</span> <span class="n">param</span> <span class="o">-</span> <span class="n">param_list</span><span class="p">[</span>
                        <span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">*</span> <span class="n">weight_decay</span> <span class="o">*</span> <span class="n">scheduled_lr</span>
                    <span class="n">fluid</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="n">param</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="n">updated_param</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">scheduled_lr</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># # yapf: disable</span>
<span class="c1"># parser = argparse.ArgumentParser()</span>
<span class="c1"># model_g = ArgumentGroup(parser, &quot;model&quot;, &quot;model configuration and paths.&quot;)</span>
<span class="c1"># model_g.add_arg(&quot;hidden_size&quot;,              int, 256,            &quot;CoKE model config: hidden size, default 256&quot;)</span>
<span class="c1"># model_g.add_arg(&quot;num_hidden_layers&quot;,        int, 6,              &quot;CoKE model config: num_hidden_layers, default 6&quot;)</span>
<span class="c1"># model_g.add_arg(&quot;num_attention_heads&quot;,      int, 4,              &quot;CoKE model config: num_attention_heads, default 4&quot;)</span>
<span class="c1"># model_g.add_arg(&quot;vocab_size&quot;,               int, -1,           &quot;CoKE model config: vocab_size&quot;)</span>
<span class="c1"># model_g.add_arg(&quot;num_relations&quot;,         int, None,           &quot;CoKE model config: vocab_size&quot;)</span>
<span class="c1"># model_g.add_arg(&quot;max_position_embeddings&quot;,  int, 10,             &quot;CoKE model config: max_position_embeddings&quot;)</span>
<span class="c1"># model_g.add_arg(&quot;hidden_act&quot;,               str, &quot;gelu&quot;,         &quot;CoKE model config: hidden_ac, default gelu&quot;)</span>
<span class="c1"># model_g.add_arg(&quot;hidden_dropout_prob&quot;,      float, 0.1,          &quot;CoKE model config: attention_probs_dropout_prob, default 0.1&quot;)</span>
<span class="c1"># model_g.add_arg(&quot;attention_probs_dropout_prob&quot;, float, 0.1,      &quot;CoKE model config: attention_probs_dropout_prob, default 0.1&quot;)</span>
<span class="c1"># model_g.add_arg(&quot;initializer_range&quot;,        int, 0.02,           &quot;CoKE model config: initializer_range&quot;)</span>
<span class="c1"># model_g.add_arg(&quot;intermediate_size&quot;,        int, 512,            &quot;CoKE model config: intermediate_size, default 512&quot;)</span>

<span class="c1"># model_g.add_arg(&quot;init_checkpoint&quot;,          str,  None,          &quot;Init checkpoint to resume training from, or for prediction only&quot;)</span>
<span class="c1"># model_g.add_arg(&quot;init_pretraining_params&quot;,  str,  None,          &quot;Init pre-training params which preforms fine-tuning from. If the &quot;</span>
<span class="c1">#                  &quot;arg &#39;init_checkpoint&#39; has been set, this argument wouldn&#39;t be valid.&quot;)</span>
<span class="c1"># model_g.add_arg(&quot;checkpoints&quot;,              str,  &quot;checkpoints&quot;, &quot;Path to save checkpoints.&quot;)</span>
<span class="c1"># model_g.add_arg(&quot;weight_sharing&quot;,           bool, True,          &quot;If set, share weights between word embedding and masked lm.&quot;)</span>

<span class="c1"># train_g = ArgumentGroup(parser, &quot;training&quot;, &quot;training options.&quot;)</span>
<span class="c1"># train_g.add_arg(&quot;epoch&quot;,             int,    100,                &quot;Number of epoches for training.&quot;)</span>
<span class="c1"># train_g.add_arg(&quot;learning_rate&quot;,     float,  5e-5,               &quot;Learning rate used to train with warmup.&quot;)</span>
<span class="c1"># train_g.add_arg(&quot;lr_scheduler&quot;,     str, &quot;linear_warmup_decay&quot;,  &quot;scheduler of learning rate.&quot;,</span>
<span class="c1">#                 choices=[&#39;linear_warmup_decay&#39;, &#39;noam_decay&#39;])</span>
<span class="c1"># train_g.add_arg(&quot;soft_label&quot;,               float, 0.9,          &quot;Value of soft labels for loss computation&quot;)</span>
<span class="c1"># train_g.add_arg(&quot;weight_decay&quot;,      float,  0.01,               &quot;Weight decay rate for L2 regularizer.&quot;)</span>
<span class="c1"># train_g.add_arg(&quot;warmup_proportion&quot;, float,  0.1,                &quot;Proportion of training steps to perform linear learning rate warmup for.&quot;)</span>
<span class="c1"># train_g.add_arg(&quot;use_ema&quot;,           bool,   True,               &quot;Whether to use ema.&quot;)</span>
<span class="c1"># train_g.add_arg(&quot;ema_decay&quot;,         float,  0.9999,             &quot;Decay rate for expoential moving average.&quot;)</span>
<span class="c1"># train_g.add_arg(&quot;use_fp16&quot;,          bool,   False,              &quot;Whether to use fp16 mixed precision training.&quot;)</span>
<span class="c1"># train_g.add_arg(&quot;loss_scaling&quot;,      float,  1.0,                &quot;Loss scaling factor for mixed precision training, only valid when use_fp16 is enabled.&quot;)</span>

<span class="c1"># log_g = ArgumentGroup(parser, &quot;logging&quot;, &quot;logging related.&quot;)</span>
<span class="c1"># log_g.add_arg(&quot;skip_steps&quot;,          int,    1000,               &quot;The steps interval to print loss.&quot;)</span>
<span class="c1"># log_g.add_arg(&quot;verbose&quot;,             bool,   False,              &quot;Whether to output verbose log.&quot;)</span>

<span class="c1"># data_g = ArgumentGroup(parser, &quot;data&quot;, &quot;Data paths, vocab paths and data processing options&quot;)</span>
<span class="c1"># data_g.add_arg(&quot;dataset&quot;,                   str,   &quot;&quot;,    &quot;dataset name&quot;)</span>
<span class="c1"># data_g.add_arg(&quot;train_file&quot;,                str,   None,  &quot;Data for training.&quot;)</span>
<span class="c1"># data_g.add_arg(&quot;sen_candli_file&quot;,           str,   None,  &quot;sentence_candicate_list file for path query evaluation. Only used for path query datasets&quot;)</span>
<span class="c1"># data_g.add_arg(&quot;sen_trivial_file&quot;,           str,   None,  &quot;trivial sentence file for pathquery evaluation. Only used for path query datasets&quot;)</span>
<span class="c1"># data_g.add_arg(&quot;predict_file&quot;,              str,   None,  &quot;Data for predictions.&quot;)</span>
<span class="c1"># data_g.add_arg(&quot;vocab_path&quot;,                str,   None,  &quot;Path to vocabulary.&quot;)</span>
<span class="c1"># data_g.add_arg(&quot;true_triple_path&quot;,          str,   None,  &quot;Path to all true triples. Only used for KBC evaluation.&quot;)</span>
<span class="c1"># data_g.add_arg(&quot;max_seq_len&quot;,               int,   3,     &quot;Number of tokens of the longest sequence.&quot;)</span>
<span class="c1"># data_g.add_arg(&quot;batch_size&quot;,                int,   12,    &quot;Total examples&#39; number in batch for training. see also --in_tokens.&quot;)</span>
<span class="c1"># data_g.add_arg(&quot;in_tokens&quot;,                 bool,  False,</span>
<span class="c1">#                &quot;If set, the batch size will be the maximum number of tokens in one batch. &quot;</span>
<span class="c1">#                &quot;Otherwise, it will be the maximum number of examples in one batch.&quot;)</span>

<span class="c1"># run_type_g = ArgumentGroup(parser, &quot;run_type&quot;, &quot;running type options.&quot;)</span>
<span class="c1"># run_type_g.add_arg(&quot;do_train&quot;,                     bool,   False,  &quot;Whether to perform training.&quot;)</span>
<span class="c1"># run_type_g.add_arg(&quot;do_predict&quot;,                   bool,   False,  &quot;Whether to perform prediction.&quot;)</span>
<span class="c1"># run_type_g.add_arg(&quot;use_cuda&quot;,                     bool,   True,   &quot;If set, use GPU for training, default is True.&quot;)</span>
<span class="c1"># run_type_g.add_arg(&quot;use_fast_executor&quot;,            bool,   False,  &quot;If set, use fast parallel executor (in experiment).&quot;)</span>
<span class="c1"># run_type_g.add_arg(&quot;num_iteration_per_drop_scope&quot;, int,    1,      &quot;Ihe iteration intervals to clean up temporary variables.&quot;)</span>

<span class="c1"># args = parser.parse_args(args={})</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">create_model</span><span class="p">(</span><span class="n">pyreader_name</span><span class="p">,</span> <span class="n">coke_config</span><span class="p">):</span>
    <span class="n">pyreader</span> <span class="o">=</span> <span class="n">fluid</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">py_reader</span>\
            <span class="p">(</span>
        <span class="n">capacity</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
        <span class="n">shapes</span><span class="o">=</span><span class="p">[[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">max_seq_len</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">max_seq_len</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">max_seq_len</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]],</span>
        <span class="n">dtypes</span><span class="o">=</span><span class="p">[</span>
            <span class="s1">&#39;int64&#39;</span><span class="p">,</span> <span class="s1">&#39;int64&#39;</span><span class="p">,</span> <span class="s1">&#39;float32&#39;</span><span class="p">,</span> <span class="s1">&#39;int64&#39;</span><span class="p">,</span> <span class="s1">&#39;int64&#39;</span><span class="p">],</span>
        <span class="n">lod_levels</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="n">name</span><span class="o">=</span><span class="n">pyreader_name</span><span class="p">,</span>
        <span class="n">use_double_buffer</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="p">(</span><span class="n">src_ids</span><span class="p">,</span> <span class="n">pos_ids</span><span class="p">,</span> <span class="n">input_mask</span><span class="p">,</span> <span class="n">mask_labels</span><span class="p">,</span> <span class="n">mask_positions</span><span class="p">)</span> <span class="o">=</span> <span class="n">fluid</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">pyreader</span><span class="p">)</span>

    <span class="n">coke</span> <span class="o">=</span> <span class="n">CoKEModel</span><span class="p">(</span>
        <span class="n">src_ids</span><span class="o">=</span><span class="n">src_ids</span><span class="p">,</span>
        <span class="n">position_ids</span><span class="o">=</span><span class="n">pos_ids</span><span class="p">,</span>
        <span class="n">input_mask</span><span class="o">=</span><span class="n">input_mask</span><span class="p">,</span>
        <span class="n">config</span><span class="o">=</span><span class="n">coke_config</span><span class="p">,</span>
        <span class="n">soft_label</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">soft_label</span><span class="p">,</span>
        <span class="n">weight_sharing</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">weight_sharing</span><span class="p">,</span>
        <span class="n">use_fp16</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">use_fp16</span><span class="p">)</span>

    <span class="n">loss</span><span class="p">,</span> <span class="n">fc_out</span> <span class="o">=</span> <span class="n">coke</span><span class="o">.</span><span class="n">get_pretraining_output</span><span class="p">(</span><span class="n">mask_label</span><span class="o">=</span><span class="n">mask_labels</span><span class="p">,</span> <span class="n">mask_pos</span><span class="o">=</span><span class="n">mask_positions</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">use_fp16</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">loss_scaling</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">loss</span> <span class="o">*</span> <span class="n">args</span><span class="o">.</span><span class="n">loss_scaling</span>

    <span class="n">batch_ones</span> <span class="o">=</span> <span class="n">fluid</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">fill_constant_batch_size_like</span><span class="p">(</span>
        <span class="nb">input</span><span class="o">=</span><span class="n">mask_labels</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int64&#39;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">value</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">num_seqs</span> <span class="o">=</span> <span class="n">fluid</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">batch_ones</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pyreader</span><span class="p">,</span> <span class="n">loss</span><span class="p">,</span> <span class="n">fc_out</span><span class="p">,</span> <span class="n">num_seqs</span>


<span class="k">def</span> <span class="nf">pathquery_predict</span><span class="p">(</span><span class="n">test_exe</span><span class="p">,</span> <span class="n">test_program</span><span class="p">,</span> <span class="n">test_pyreader</span><span class="p">,</span> <span class="n">fetch_list</span><span class="p">,</span> <span class="n">all_examples</span><span class="p">,</span>
                      <span class="n">sen_negli_dict</span><span class="p">,</span> <span class="n">trivial_sen_set</span><span class="p">,</span> <span class="n">eval_result_file</span><span class="p">):</span>
    <span class="n">eval_i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">step</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">batch_mqs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">batch_ranks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">test_pyreader</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">np_fc_out</span> <span class="o">=</span> <span class="n">test_exe</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">fetch_list</span><span class="o">=</span><span class="n">fetch_list</span><span class="p">,</span> <span class="n">program</span><span class="o">=</span><span class="n">test_program</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">mqs</span><span class="p">,</span> <span class="n">ranks</span> <span class="o">=</span> <span class="n">pathquery_batch_evaluation</span><span class="p">(</span><span class="n">eval_i</span><span class="p">,</span> <span class="n">all_examples</span><span class="p">,</span> <span class="n">np_fc_out</span><span class="p">,</span>
                                                    <span class="n">sen_negli_dict</span><span class="p">,</span> <span class="n">trivial_sen_set</span><span class="p">)</span>
            <span class="n">batch_mqs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">mqs</span><span class="p">)</span>
            <span class="n">batch_ranks</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ranks</span><span class="p">)</span>
            <span class="n">step</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">step</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Processing pathquery_predict step:</span><span class="si">%d</span><span class="s2"> example: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">eval_i</span><span class="p">))</span>
            <span class="n">_batch_len</span> <span class="o">=</span> <span class="n">np_fc_out</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">eval_i</span> <span class="o">+=</span> <span class="n">_batch_len</span>
        <span class="k">except</span> <span class="n">fluid</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">EOFException</span><span class="p">:</span>
            <span class="n">test_pyreader</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
            <span class="k">break</span>

    <span class="n">eval_result</span> <span class="o">=</span> <span class="n">compute_pathquery_metrics</span><span class="p">(</span><span class="n">batch_mqs</span><span class="p">,</span> <span class="n">batch_ranks</span><span class="p">,</span> <span class="n">eval_result_file</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">eval_result</span>


<span class="k">def</span> <span class="nf">kbc_predict</span><span class="p">(</span><span class="n">test_exe</span><span class="p">,</span> <span class="n">test_program</span><span class="p">,</span> <span class="n">test_pyreader</span><span class="p">,</span> <span class="n">fetch_list</span><span class="p">,</span> <span class="n">all_examples</span><span class="p">,</span> <span class="n">true_triplets_dict</span><span class="p">,</span> <span class="n">eval_result_file</span><span class="p">):</span>
    <span class="n">eval_i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">step</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">batch_eval_rets</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">f_batch_eval_rets</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">test_pyreader</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">batch_results</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">np_fc_out</span> <span class="o">=</span> <span class="n">test_exe</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">fetch_list</span><span class="o">=</span><span class="n">fetch_list</span><span class="p">,</span> <span class="n">program</span><span class="o">=</span><span class="n">test_program</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">_batch_len</span> <span class="o">=</span> <span class="n">np_fc_out</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np_fc_out</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">logits</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">np_fc_out</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">flat</span><span class="p">]</span>
                <span class="n">batch_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">logits</span><span class="p">)</span>
            <span class="n">rank</span><span class="p">,</span> <span class="n">frank</span> <span class="o">=</span> <span class="n">kbc_batch_evaluation</span><span class="p">(</span><span class="n">eval_i</span><span class="p">,</span> <span class="n">all_examples</span><span class="p">,</span> <span class="n">batch_results</span><span class="p">,</span> <span class="n">true_triplets_dict</span><span class="p">)</span>
            <span class="n">batch_eval_rets</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">rank</span><span class="p">)</span>
            <span class="n">f_batch_eval_rets</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">frank</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">step</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Processing kbc_predict step: </span><span class="si">%d</span><span class="s2"> exmaples:</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">eval_i</span><span class="p">))</span>
            <span class="n">step</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">eval_i</span> <span class="o">+=</span> <span class="n">_batch_len</span>
        <span class="k">except</span> <span class="n">fluid</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">EOFException</span><span class="p">:</span>
            <span class="n">test_pyreader</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
            <span class="k">break</span>
    <span class="n">eval_result</span> <span class="o">=</span> <span class="n">compute_kbc_metrics</span><span class="p">(</span><span class="n">batch_eval_rets</span><span class="p">,</span> <span class="n">f_batch_eval_rets</span><span class="p">,</span> <span class="n">eval_result_file</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">eval_result</span>


<span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="n">test_exe</span><span class="p">,</span> <span class="n">test_program</span><span class="p">,</span> <span class="n">test_pyreader</span><span class="p">,</span> <span class="n">fetch_list</span><span class="p">,</span> <span class="n">all_examples</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">dataset</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">checkpoints</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">checkpoints</span><span class="p">)</span>
    <span class="n">eval_result_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">checkpoints</span><span class="p">,</span> <span class="s2">&quot;eval_result.json&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&gt;&gt; Evaluation result file: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">eval_result_file</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">dataset</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;pathquerywn&quot;</span><span class="p">,</span> <span class="s2">&quot;pathqueryfb&quot;</span><span class="p">]:</span>
        <span class="n">sen_candli_dict</span><span class="p">,</span> <span class="n">trivial_sen_set</span> <span class="o">=</span> <span class="n">_load_pathquery_eval_dict</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">sen_candli_file</span><span class="p">,</span>
                                                                   <span class="n">args</span><span class="o">.</span><span class="n">sen_trivial_file</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;&gt;&gt; Load sen_candli_dict size: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">sen_candli_dict</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;&gt;&gt; Trivial sen set size: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">trivial_sen_set</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;&gt;&gt; Finish load sen_candli set at:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">ctime</span><span class="p">()))</span>
        <span class="n">eval_performance</span> <span class="o">=</span> <span class="n">pathquery_predict</span><span class="p">(</span><span class="n">test_exe</span><span class="p">,</span> <span class="n">test_program</span><span class="p">,</span> <span class="n">test_pyreader</span><span class="p">,</span> <span class="n">fetch_list</span><span class="p">,</span>
                                              <span class="n">all_examples</span><span class="p">,</span> <span class="n">sen_candli_dict</span><span class="p">,</span> <span class="n">trivial_sen_set</span><span class="p">,</span>
                                              <span class="n">eval_result_file</span><span class="p">)</span>

        <span class="n">outs</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="se">\t</span><span class="si">%.3f</span><span class="se">\t</span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">dataset</span><span class="p">,</span> <span class="n">eval_performance</span><span class="p">[</span><span class="s1">&#39;mq&#39;</span><span class="p">],</span> <span class="n">eval_performance</span><span class="p">[</span><span class="s1">&#39;fhits10&#39;</span><span class="p">])</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">---------- Evaluation Performance --------------</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                    <span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;TASK&quot;</span><span class="p">,</span> <span class="s2">&quot;MQ&quot;</span><span class="p">,</span> <span class="s2">&quot;Hits@10&quot;</span><span class="p">]),</span> <span class="n">outs</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">true_triplets_dict</span> <span class="o">=</span> <span class="n">_load_kbc_eval_dict</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">true_triple_path</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&gt;&gt; Finish loading true triplets dict </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">time</span><span class="o">.</span><span class="n">ctime</span><span class="p">())</span>
        <span class="n">eval_performance</span> <span class="o">=</span> <span class="n">kbc_predict</span><span class="p">(</span><span class="n">test_exe</span><span class="p">,</span> <span class="n">test_program</span><span class="p">,</span> <span class="n">test_pyreader</span><span class="p">,</span> <span class="n">fetch_list</span><span class="p">,</span>
                                        <span class="n">all_examples</span><span class="p">,</span> <span class="n">true_triplets_dict</span><span class="p">,</span> <span class="n">eval_result_file</span><span class="p">)</span>
        <span class="n">outs</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="se">\t</span><span class="si">%.3f</span><span class="se">\t</span><span class="si">%.3f</span><span class="se">\t</span><span class="si">%.3f</span><span class="se">\t</span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">dataset</span><span class="p">,</span>
                                               <span class="n">eval_performance</span><span class="p">[</span><span class="s1">&#39;fmrr&#39;</span><span class="p">],</span>
                                               <span class="n">eval_performance</span><span class="p">[</span><span class="s1">&#39;fhits1&#39;</span><span class="p">],</span>
                                               <span class="n">eval_performance</span><span class="p">[</span><span class="s1">&#39;fhits3&#39;</span><span class="p">],</span>
                                               <span class="n">eval_performance</span><span class="p">[</span><span class="s1">&#39;fhits10&#39;</span><span class="p">])</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">----------- Evaluation Performance --------------</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                    <span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;TASK&quot;</span><span class="p">,</span> <span class="s2">&quot;MRR&quot;</span><span class="p">,</span> <span class="s2">&quot;Hits@1&quot;</span><span class="p">,</span> <span class="s2">&quot;Hits@3&quot;</span><span class="p">,</span> <span class="s2">&quot;Hits@10&quot;</span><span class="p">]),</span> <span class="n">outs</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">eval_performance</span>


<span class="k">def</span> <span class="nf">_load_kbc_eval_dict</span><span class="p">(</span><span class="n">true_triple_file</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">load_true_triples</span><span class="p">(</span><span class="n">true_triple_file</span><span class="p">):</span>
        <span class="n">true_triples</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">true_triple_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fr</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fr</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
                <span class="n">tokens</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span>
                <span class="n">true_triples</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">2</span><span class="p">])))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Finish loading </span><span class="si">%d</span><span class="s2"> true triples&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">true_triples</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">true_triples</span>
    <span class="n">true_triples</span> <span class="o">=</span> <span class="n">load_true_triples</span><span class="p">(</span><span class="n">true_triple_file</span><span class="p">)</span>
    <span class="n">true_triples_dict</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;hs&#39;</span><span class="p">:</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">),</span>
                                          <span class="s1">&#39;ts&#39;</span><span class="p">:</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)})</span>
    <span class="k">for</span> <span class="n">h</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">true_triples</span><span class="p">:</span>
        <span class="n">true_triples_dict</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="s1">&#39;ts&#39;</span><span class="p">][</span><span class="n">h</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">true_triples_dict</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="s1">&#39;hs&#39;</span><span class="p">][</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">true_triples_dict</span>


<span class="k">def</span> <span class="nf">_load_pathquery_eval_dict</span><span class="p">(</span><span class="n">sen_candli_file</span><span class="p">,</span> <span class="n">trivial_sen_file</span><span class="p">,</span> <span class="n">add_gold_o</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
    <span class="n">sen_candli_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">sen_candli_file</span><span class="p">):</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">segs</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">segs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot; Illegal format for sen_candli_dict, expects 2 columns data&quot;</span>
        <span class="n">sen</span> <span class="o">=</span> <span class="n">segs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">candset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">segs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">add_gold_o</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">gold_o</span> <span class="o">=</span> <span class="n">sen</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">candset</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">gold_o</span><span class="p">)</span>
        <span class="n">_li</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">candset</span><span class="p">)</span>
        <span class="n">int_li</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">_li</span><span class="p">]</span>
        <span class="n">sen_candli_dict</span><span class="p">[</span><span class="n">sen</span><span class="p">]</span> <span class="o">=</span> <span class="n">int_li</span>
    <span class="n">trivial_senset</span> <span class="o">=</span> <span class="p">{</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">trivial_sen_file</span><span class="p">)}</span>

    <span class="k">return</span> <span class="n">sen_candli_dict</span><span class="p">,</span> <span class="n">trivial_senset</span>


<span class="k">def</span> <span class="nf">init_coke_net_config</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">print_config</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
    <span class="n">config</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">config</span><span class="p">[</span><span class="s2">&quot;hidden_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">hidden_size</span>
    <span class="n">config</span><span class="p">[</span><span class="s2">&quot;num_hidden_layers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">num_hidden_layers</span>
    <span class="n">config</span><span class="p">[</span><span class="s2">&quot;num_attention_heads&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">num_attention_heads</span>
    <span class="n">config</span><span class="p">[</span><span class="s2">&quot;vocab_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">vocab_size</span>
    <span class="n">config</span><span class="p">[</span><span class="s2">&quot;num_relations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">num_relations</span>
    <span class="n">config</span><span class="p">[</span><span class="s2">&quot;max_position_embeddings&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">max_position_embeddings</span>
    <span class="n">config</span><span class="p">[</span><span class="s2">&quot;hidden_act&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">hidden_act</span>
    <span class="n">config</span><span class="p">[</span><span class="s2">&quot;hidden_dropout_prob&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">hidden_dropout_prob</span>
    <span class="n">config</span><span class="p">[</span><span class="s2">&quot;attention_probs_dropout_prob&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">attention_probs_dropout_prob</span>
    <span class="n">config</span><span class="p">[</span><span class="s2">&quot;initializer_range&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">initializer_range</span>
    <span class="n">config</span><span class="p">[</span><span class="s2">&quot;intermediate_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">intermediate_size</span>

    <span class="k">if</span> <span class="n">print_config</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;----------- CoKE Network Configuration -------------&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">arg</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;------------------------------------------------&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">config</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">do_train</span> <span class="ow">or</span> <span class="n">args</span><span class="o">.</span><span class="n">do_predict</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;For args `do_train` and `do_predict`, at &quot;</span>
                         <span class="s2">&quot;least one of them must be True.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">use_cuda</span><span class="p">:</span>
        <span class="n">place</span> <span class="o">=</span> <span class="n">fluid</span><span class="o">.</span><span class="n">CUDAPlace</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">dev_count</span> <span class="o">=</span> <span class="n">fluid</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">get_cuda_device_count</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">place</span> <span class="o">=</span> <span class="n">fluid</span><span class="o">.</span><span class="n">CPUPlace</span><span class="p">()</span>
        <span class="n">dev_count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;CPU_NUM&#39;</span><span class="p">,</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()))</span>
    <span class="n">exe</span> <span class="o">=</span> <span class="n">fluid</span><span class="o">.</span><span class="n">Executor</span><span class="p">(</span><span class="n">place</span><span class="p">)</span>

    <span class="n">startup_prog</span> <span class="o">=</span> <span class="n">fluid</span><span class="o">.</span><span class="n">Program</span><span class="p">()</span>

    <span class="c1"># Init programs</span>
    <span class="n">coke_config</span> <span class="o">=</span> <span class="n">init_coke_net_config</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">print_config</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">do_train</span><span class="p">:</span>
        <span class="n">train_data_reader</span> <span class="o">=</span> <span class="n">get_data_reader</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">train_file</span><span class="p">,</span> <span class="n">is_training</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                            <span class="n">epoch</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">epoch</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dev_count</span><span class="o">=</span><span class="n">dev_count</span><span class="p">,</span>
                                            <span class="n">vocab_size</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">vocab_size</span><span class="p">)</span>

        <span class="n">num_train_examples</span> <span class="o">=</span> <span class="n">train_data_reader</span><span class="o">.</span><span class="n">total_instance</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">in_tokens</span><span class="p">:</span>
            <span class="n">max_train_steps</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">epoch</span> <span class="o">*</span> <span class="n">num_train_examples</span> <span class="o">//</span> <span class="p">(</span>
                    <span class="n">args</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">//</span> <span class="n">args</span><span class="o">.</span><span class="n">max_seq_len</span><span class="p">)</span> <span class="o">//</span> <span class="n">dev_count</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">max_train_steps</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">epoch</span> <span class="o">*</span> <span class="n">num_train_examples</span> <span class="o">//</span> <span class="p">(</span>
                <span class="n">args</span><span class="o">.</span><span class="n">batch_size</span><span class="p">)</span> <span class="o">//</span> <span class="n">dev_count</span>
        <span class="n">warmup_steps</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">max_train_steps</span> <span class="o">*</span> <span class="n">args</span><span class="o">.</span><span class="n">warmup_proportion</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Device count: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">dev_count</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Num train examples: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">num_train_examples</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Max train steps: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">max_train_steps</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Num warmup steps: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">warmup_steps</span><span class="p">)</span>

        <span class="n">train_program</span> <span class="o">=</span> <span class="n">fluid</span><span class="o">.</span><span class="n">Program</span><span class="p">()</span>

        <span class="c1"># Create model and set optimization for train</span>
        <span class="k">with</span> <span class="n">fluid</span><span class="o">.</span><span class="n">program_guard</span><span class="p">(</span><span class="n">train_program</span><span class="p">,</span> <span class="n">startup_prog</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">fluid</span><span class="o">.</span><span class="n">unique_name</span><span class="o">.</span><span class="n">guard</span><span class="p">():</span>
                <span class="n">train_pyreader</span><span class="p">,</span> <span class="n">loss</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">num_seqs</span> <span class="o">=</span> <span class="n">create_model</span><span class="p">(</span>
                    <span class="n">pyreader_name</span><span class="o">=</span><span class="s1">&#39;train_reader&#39;</span><span class="p">,</span>
                    <span class="n">coke_config</span><span class="o">=</span><span class="n">coke_config</span><span class="p">)</span>

                <span class="n">scheduled_lr</span> <span class="o">=</span> <span class="n">optimization</span><span class="p">(</span>
                    <span class="n">loss</span><span class="o">=</span><span class="n">loss</span><span class="p">,</span>
                    <span class="n">warmup_steps</span><span class="o">=</span><span class="n">warmup_steps</span><span class="p">,</span>
                    <span class="n">num_train_steps</span><span class="o">=</span><span class="n">max_train_steps</span><span class="p">,</span>
                    <span class="n">learning_rate</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">,</span>
                    <span class="n">train_program</span><span class="o">=</span><span class="n">train_program</span><span class="p">,</span>
                    <span class="n">startup_prog</span><span class="o">=</span><span class="n">startup_prog</span><span class="p">,</span>
                    <span class="n">weight_decay</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">weight_decay</span><span class="p">,</span>
                    <span class="n">scheduler</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">lr_scheduler</span><span class="p">,</span>
                    <span class="n">use_fp16</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">use_fp16</span><span class="p">,</span>
                    <span class="n">loss_scaling</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">loss_scaling</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">use_ema</span><span class="p">:</span>
                    <span class="n">ema</span> <span class="o">=</span> <span class="n">fluid</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">ExponentialMovingAverage</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">ema_decay</span><span class="p">)</span>
                    <span class="n">ema</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

                <span class="n">fluid</span><span class="o">.</span><span class="n">memory_optimize</span><span class="p">(</span><span class="n">train_program</span><span class="p">,</span> <span class="n">skip_opt_set</span><span class="o">=</span><span class="p">[</span><span class="n">loss</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">num_seqs</span><span class="o">.</span><span class="n">name</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">in_tokens</span><span class="p">:</span>
                <span class="n">lower_mem</span><span class="p">,</span> <span class="n">upper_mem</span><span class="p">,</span> <span class="n">unit</span> <span class="o">=</span> <span class="n">fluid</span><span class="o">.</span><span class="n">contrib</span><span class="o">.</span><span class="n">memory_usage</span><span class="p">(</span>
                    <span class="n">program</span><span class="o">=</span><span class="n">train_program</span><span class="p">,</span>
                    <span class="n">batch_size</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">//</span> <span class="n">args</span><span class="o">.</span><span class="n">max_seq_len</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lower_mem</span><span class="p">,</span> <span class="n">upper_mem</span><span class="p">,</span> <span class="n">unit</span> <span class="o">=</span> <span class="n">fluid</span><span class="o">.</span><span class="n">contrib</span><span class="o">.</span><span class="n">memory_usage</span><span class="p">(</span>
                    <span class="n">program</span><span class="o">=</span><span class="n">train_program</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">batch_size</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Theoretical memory usage in training:  </span><span class="si">%.3f</span><span class="s2"> - </span><span class="si">%.3f</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                        <span class="p">(</span><span class="n">lower_mem</span><span class="p">,</span> <span class="n">upper_mem</span><span class="p">,</span> <span class="n">unit</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">do_predict</span><span class="p">:</span>
        <span class="c1"># Create model for prediction</span>
        <span class="n">test_prog</span> <span class="o">=</span> <span class="n">fluid</span><span class="o">.</span><span class="n">Program</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">fluid</span><span class="o">.</span><span class="n">program_guard</span><span class="p">(</span><span class="n">test_prog</span><span class="p">,</span> <span class="n">startup_prog</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">fluid</span><span class="o">.</span><span class="n">unique_name</span><span class="o">.</span><span class="n">guard</span><span class="p">():</span>
                <span class="n">test_pyreader</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">fc_out</span><span class="p">,</span> <span class="n">num_seqs</span> <span class="o">=</span> <span class="n">create_model</span><span class="p">(</span>
                    <span class="n">pyreader_name</span><span class="o">=</span><span class="s1">&#39;test_reader&#39;</span><span class="p">,</span>
                    <span class="n">coke_config</span><span class="o">=</span><span class="n">coke_config</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">use_ema</span> <span class="ow">and</span> <span class="s1">&#39;ema&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">():</span>
                    <span class="n">ema</span> <span class="o">=</span> <span class="n">fluid</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">ExponentialMovingAverage</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">ema_decay</span><span class="p">)</span>

                <span class="n">fluid</span><span class="o">.</span><span class="n">memory_optimize</span><span class="p">(</span><span class="n">test_prog</span><span class="p">,</span> <span class="n">skip_opt_set</span><span class="o">=</span><span class="p">[</span><span class="n">fc_out</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">num_seqs</span><span class="o">.</span><span class="n">name</span><span class="p">])</span>

        <span class="n">test_prog</span> <span class="o">=</span> <span class="n">test_prog</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">for_test</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">exe</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">startup_prog</span><span class="p">)</span>

    <span class="c1"># Init checkpoints</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">do_train</span><span class="p">:</span>
        <span class="n">init_train_checkpoint</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">exe</span><span class="p">,</span> <span class="n">startup_prog</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">do_predict</span><span class="p">:</span>
        <span class="n">init_predict_checkpoint</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">exe</span><span class="p">,</span> <span class="n">startup_prog</span><span class="p">)</span>

    <span class="c1"># Run training</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">do_train</span><span class="p">:</span>
        <span class="n">exec_strategy</span> <span class="o">=</span> <span class="n">fluid</span><span class="o">.</span><span class="n">ExecutionStrategy</span><span class="p">()</span>
        <span class="n">exec_strategy</span><span class="o">.</span><span class="n">use_experimental_executor</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">use_fast_executor</span>
        <span class="n">exec_strategy</span><span class="o">.</span><span class="n">num_threads</span> <span class="o">=</span> <span class="n">dev_count</span>
        <span class="n">exec_strategy</span><span class="o">.</span><span class="n">num_iteration_per_drop_scope</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">num_iteration_per_drop_scope</span>

        <span class="n">train_exe</span> <span class="o">=</span> <span class="n">fluid</span><span class="o">.</span><span class="n">ParallelExecutor</span><span class="p">(</span>
            <span class="n">use_cuda</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">use_cuda</span><span class="p">,</span>
            <span class="n">loss_name</span><span class="o">=</span><span class="n">loss</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">exec_strategy</span><span class="o">=</span><span class="n">exec_strategy</span><span class="p">,</span>
            <span class="n">main_program</span><span class="o">=</span><span class="n">train_program</span><span class="p">)</span>

        <span class="n">train_pyreader</span><span class="o">.</span><span class="n">decorate_tensor_provider</span><span class="p">(</span><span class="n">train_data_reader</span><span class="o">.</span><span class="n">data_generator</span><span class="p">())</span>

        <span class="n">train_pyreader</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">steps</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">total_cost</span><span class="p">,</span> <span class="n">total_num_seqs</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="n">time_begin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">steps</span> <span class="o">&lt;</span> <span class="n">max_train_steps</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">steps</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">steps</span> <span class="o">%</span> <span class="n">args</span><span class="o">.</span><span class="n">skip_steps</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">warmup_steps</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">fetch_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">loss</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">num_seqs</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">fetch_list</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="n">loss</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">scheduled_lr</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">num_seqs</span><span class="o">.</span><span class="n">name</span>
                        <span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fetch_list</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="n">outputs</span> <span class="o">=</span> <span class="n">train_exe</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">fetch_list</span><span class="o">=</span><span class="n">fetch_list</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">steps</span> <span class="o">%</span> <span class="n">args</span><span class="o">.</span><span class="n">skip_steps</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">warmup_steps</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">np_loss</span><span class="p">,</span> <span class="n">np_num_seqs</span> <span class="o">=</span> <span class="n">outputs</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">np_loss</span><span class="p">,</span> <span class="n">np_lr</span><span class="p">,</span> <span class="n">np_num_seqs</span> <span class="o">=</span> <span class="n">outputs</span>
                    <span class="n">total_cost</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">np_loss</span> <span class="o">*</span> <span class="n">np_num_seqs</span><span class="p">)</span>
                    <span class="n">total_num_seqs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">np_num_seqs</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                        <span class="n">verbose</span> <span class="o">=</span> <span class="s2">&quot;train pyreader queue size: </span><span class="si">%d</span><span class="s2">, &quot;</span> <span class="o">%</span> <span class="n">train_pyreader</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">size</span><span class="p">(</span>
                        <span class="p">)</span>
                        <span class="n">verbose</span> <span class="o">+=</span> <span class="s2">&quot;learning rate: </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">np_lr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">warmup_steps</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">args</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">verbose</span><span class="p">)</span>

                    <span class="n">time_end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                    <span class="n">used_time</span> <span class="o">=</span> <span class="n">time_end</span> <span class="o">-</span> <span class="n">time_begin</span>
                    <span class="n">current_example</span><span class="p">,</span> <span class="n">epoch</span> <span class="o">=</span> <span class="n">train_data_reader</span><span class="o">.</span><span class="n">get_progress</span><span class="p">()</span>

                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;epoch: </span><span class="si">%d</span><span class="s2">, progress: </span><span class="si">%d</span><span class="s2">/</span><span class="si">%d</span><span class="s2">, step: </span><span class="si">%d</span><span class="s2">, loss: </span><span class="si">%f</span><span class="s2">, &quot;</span>
                                <span class="s2">&quot;speed: </span><span class="si">%f</span><span class="s2"> steps/s&quot;</span> <span class="o">%</span>
                                <span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">current_example</span><span class="p">,</span> <span class="n">num_train_examples</span><span class="p">,</span> <span class="n">steps</span><span class="p">,</span>
                                 <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">total_cost</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">total_num_seqs</span><span class="p">),</span>
                                 <span class="n">args</span><span class="o">.</span><span class="n">skip_steps</span> <span class="o">/</span> <span class="n">used_time</span><span class="p">))</span>
                    <span class="n">total_cost</span><span class="p">,</span> <span class="n">total_num_seqs</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
                    <span class="n">time_begin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">steps</span> <span class="o">==</span> <span class="n">max_train_steps</span><span class="p">:</span>
                    <span class="n">save_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">checkpoints</span><span class="p">,</span> <span class="s2">&quot;step_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">steps</span><span class="p">))</span>
                    <span class="n">fluid</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">save_persistables</span><span class="p">(</span><span class="n">exe</span><span class="p">,</span> <span class="n">save_path</span><span class="p">,</span> <span class="n">train_program</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">fluid</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">EOFException</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;&gt;&gt; EOFException&quot;</span><span class="p">)</span>
                <span class="n">save_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">checkpoints</span><span class="p">,</span> <span class="s2">&quot;step_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">steps</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_final&quot;</span><span class="p">)</span>
                <span class="n">fluid</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">save_persistables</span><span class="p">(</span><span class="n">exe</span><span class="p">,</span> <span class="n">save_path</span><span class="p">,</span> <span class="n">train_program</span><span class="p">)</span>
                <span class="n">train_pyreader</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
                <span class="k">break</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&gt;&gt;Finish training at </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="n">time</span><span class="o">.</span><span class="n">ctime</span><span class="p">())</span>

    <span class="c1"># Run prediction</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">do_predict</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">dev_count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;During prediction, dev_count expects 1, current is </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">dev_count</span>
        <span class="n">test_data_reader</span> <span class="o">=</span> <span class="n">get_data_reader</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">predict_file</span><span class="p">,</span> <span class="n">is_training</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                           <span class="n">epoch</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dev_count</span><span class="o">=</span><span class="n">dev_count</span><span class="p">,</span>
                                           <span class="n">vocab_size</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">vocab_size</span><span class="p">)</span>
        <span class="n">test_pyreader</span><span class="o">.</span><span class="n">decorate_tensor_provider</span><span class="p">(</span><span class="n">test_data_reader</span><span class="o">.</span><span class="n">data_generator</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">use_ema</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">ema</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">exe</span><span class="p">):</span>
                <span class="n">eval_performance</span> <span class="o">=</span> <span class="n">predict</span><span class="p">(</span><span class="n">exe</span><span class="p">,</span> <span class="n">test_prog</span><span class="p">,</span> <span class="n">test_pyreader</span><span class="p">,</span>
                                           <span class="p">[</span><span class="n">fc_out</span><span class="o">.</span><span class="n">name</span><span class="p">],</span> <span class="n">test_data_reader</span><span class="o">.</span><span class="n">examples</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">eval_performance</span> <span class="o">=</span> <span class="n">predict</span><span class="p">(</span><span class="n">exe</span><span class="p">,</span> <span class="n">test_prog</span><span class="p">,</span> <span class="n">test_pyreader</span><span class="p">,</span>
                                       <span class="p">[</span><span class="n">fc_out</span><span class="o">.</span><span class="n">name</span><span class="p">],</span> <span class="n">test_data_reader</span><span class="o">.</span><span class="n">examples</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&gt;&gt;Finish predicting at </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="n">time</span><span class="o">.</span><span class="n">ctime</span><span class="p">())</span>


<span class="k">def</span> <span class="nf">init_predict_checkpoint</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">exe</span><span class="p">,</span> <span class="n">startup_prog</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">dataset</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;pathQueryWN&quot;</span><span class="p">,</span> <span class="s2">&quot;pathQueryFB&quot;</span><span class="p">]:</span>
        <span class="k">assert</span> <span class="n">args</span><span class="o">.</span><span class="n">sen_candli_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">sen_trivial_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;during test, pathQuery sen_candli_file and path_trivial_file must be set &quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">init_checkpoint</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;args &#39;init_checkpoint&#39; should be set if&quot;</span>
                         <span class="s2">&quot;only doing prediction!&quot;</span><span class="p">)</span>
    <span class="n">init_checkpoint</span><span class="p">(</span>
        <span class="n">exe</span><span class="p">,</span>
        <span class="n">args</span><span class="o">.</span><span class="n">init_checkpoint</span><span class="p">,</span>
        <span class="n">main_program</span><span class="o">=</span><span class="n">startup_prog</span><span class="p">,</span>
        <span class="n">use_fp16</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">use_fp16</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">init_train_checkpoint</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">exe</span><span class="p">,</span> <span class="n">startup_prog</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">init_checkpoint</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">init_pretraining_params</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;WARNING: args &#39;init_checkpoint&#39; and &#39;init_pretraining_params&#39; &quot;</span>
            <span class="s2">&quot;both are set! Only arg &#39;init_checkpoint&#39; is made valid.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">init_checkpoint</span><span class="p">:</span>
        <span class="n">init_checkpoint</span><span class="p">(</span>
            <span class="n">exe</span><span class="p">,</span>
            <span class="n">args</span><span class="o">.</span><span class="n">init_checkpoint</span><span class="p">,</span>
            <span class="n">main_program</span><span class="o">=</span><span class="n">startup_prog</span><span class="p">,</span>
            <span class="n">use_fp16</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">use_fp16</span><span class="p">,</span>
            <span class="n">print_var_verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">init_pretraining_params</span><span class="p">:</span>
        <span class="n">init_pretraining_params</span><span class="p">(</span>
            <span class="n">exe</span><span class="p">,</span>
            <span class="n">args</span><span class="o">.</span><span class="n">init_pretraining_params</span><span class="p">,</span>
            <span class="n">main_program</span><span class="o">=</span><span class="n">startup_prog</span><span class="p">,</span>
            <span class="n">use_fp16</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">use_fp16</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_data_reader</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">data_file</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">is_training</span><span class="p">,</span> <span class="n">shuffle</span><span class="p">,</span> <span class="n">dev_count</span><span class="p">,</span> <span class="n">vocab_size</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;pathqueryfb&quot;</span><span class="p">,</span> <span class="s2">&quot;pathquerywn&quot;</span><span class="p">]:</span>
        <span class="n">Reader</span> <span class="o">=</span> <span class="n">PathqueryDataReader</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Reader</span> <span class="o">=</span> <span class="n">KBCDataReader</span>
    <span class="n">data_reader</span> <span class="o">=</span> <span class="n">Reader</span><span class="p">(</span>
        <span class="n">vocab_path</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">vocab_path</span><span class="p">,</span>
        <span class="n">data_path</span><span class="o">=</span><span class="n">data_file</span><span class="p">,</span>
        <span class="n">max_seq_len</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">max_seq_len</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
        <span class="n">is_training</span><span class="o">=</span><span class="n">is_training</span><span class="p">,</span>
        <span class="n">shuffle</span><span class="o">=</span><span class="n">shuffle</span><span class="p">,</span>
        <span class="n">dev_count</span><span class="o">=</span><span class="n">dev_count</span><span class="p">,</span>
        <span class="n">epoch</span><span class="o">=</span><span class="n">epoch</span><span class="p">,</span>
        <span class="n">vocab_size</span><span class="o">=</span><span class="n">vocab_size</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data_reader</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">args</span><span class="o">.</span><span class="n">do_train</span><span class="o">=</span><span class="kc">True</span>
    <span class="n">print_arguments</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">main</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>10/11/2021 14:40:08 - INFO - __main__ - -----------  Configuration Arguments -----------
10/11/2021 14:40:08 - INFO - __main__ - do_train: True
</pre></div>
</div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "sparsh-ai/graph-embeddings",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
            



<div class='prev-next-bottom'>
    
    <div id="prev">
        <a class="left-prev" href="T457098_KHGT_knowledge_graph_embeddings.html" title="previous page">
            <i class="prevnext-label fas fa-angle-left"></i>
            <div class="prevnext-info">
                <p class="prevnext-label">previous</p>
                <p class="prevnext-title">KHGT knowledge graph embeddings</p>
            </div>
        </a>
    </div>
     <div id="next">
        <a class="right-next" href="T643979_Learning_Node_Representations_from_Multiple_Social_Contexts.html" title="next page">
            <div class="prevnext-info">
                <p class="prevnext-label">next</p>
                <p class="prevnext-title">SPLITTER: Learning Node Representations from Multiple Contexts</p>
            </div>
            <i class="prevnext-label fas fa-angle-right"></i>
        </a>
     </div>

</div>
        
        </div>
    </div>
    <footer class="footer">
    <div class="container">
      <p>
        
          By Sparsh A.<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>