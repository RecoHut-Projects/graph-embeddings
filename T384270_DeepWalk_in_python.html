
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DeepWalk in python &#8212; graph-embeddings</title>
    
  <link href="_static/css/theme.css" rel="stylesheet" />
  <link href="_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="_static/js/index.1c5a1a01449ed65a7b51.js">

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/togglebutton.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script>
        const thebe_selector = ".thebe,.cell"
        const thebe_selector_input = "pre,.cell_input div.highlight"
        const thebe_selector_output = ".output,.cell_output"
    </script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="DeepWalk on Karateclub" href="T382881_DeepWalk_on_Karateclub.html" />
    <link rel="prev" title="Graph encoder" href="T984528_Graph_encoder.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="index.html">
      
      
      
      <h1 class="site-logo" id="site-title">graph-embeddings</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="US549467_Graph_embeddings.html">
   Graph embeddings
  </a>
 </li>
</ul>
<p class="caption" role="heading">
 <span class="caption-text">
  Concepts
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="L742313_Key_developments.html">
   Key developments
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="L991141_Random_walk.html">
   Random walk
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="L128493_Skip_gram_model.html">
   Skip-gram model
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="L883045_Message_Passing_Neural_Networks.html">
   Message Passing Neural Networks
  </a>
 </li>
</ul>
<p class="caption" role="heading">
 <span class="caption-text">
  Models
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="C870584_DeepWalk.html">
   DeepWalk
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="C067906_LINE.html">
   LINE
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="C662128_SDNE.html">
   SDNE
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="C039027_Node2vec.html">
   Node2vec
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="C694808_Struc2Vec.html">
   Struc2Vec
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="C779816_Splitter.html">
   Splitter
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="C652166_CoKE.html">
   CoKE
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="C047239_GAT.html">
   GAT
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="C110059_GATv2.html">
   GATv2
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="C538124_BigGraph.html">
   BigGraph
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="C503513_KHGT.html">
   KHGT
  </a>
 </li>
</ul>
<p class="caption" role="heading">
 <span class="caption-text">
  Tutorials
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="T050508_Introduction_to_Networkx.html">
   Introduction to Networkx
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T528562_Graph_properties.html">
   Graph properties
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T118630_Graph_Benchmarks.html">
   Graph Benchmarks
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T984528_Graph_encoder.html">
   Graph encoder
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   DeepWalk in python
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T382881_DeepWalk_on_Karateclub.html">
   DeepWalk on Karateclub
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T677598_DeepWalk_on_ML_100k.html">
   DeepWalk on ML-100k
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T862985_LINE_on_Wiki_network.html">
   LINE on Wiki network
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T186367_Node2vec_from_scratch.html">
   Node2vec from scratch
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T611050_Node2vec_in_PyTorch_Geometric_on_CORA_dataset.html">
   Node2vec in PyTorch Geometric on CORA dataset
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T815556_Node2vec_on_Karateclub.html">
   Node2vec on Karateclub
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T894941_Node2vec_on_ML_latest_in_Keras.html">
   Node2vec on ML-latest in Keras
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T926278_Node2vec%2C_Edge2vec%2C_and_Graph2vec.html">
   Node2vec, Edge2vec, and Graph2vec
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T401127_GEM_on_Karateclub.html">
   GEM on Karateclub
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T481518_Struc2vec_on_airports_graph.html">
   Struc2vec on airports graph
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T516490_Learn_embeddings_using_Graph_Networks.html">
   Learn Embeddings using Graph Networks
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T981902_Shallow_embedding_methods.html">
   Shallow embedding methods
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T189677_Graph_embeddings_using_SDNE.html">
   Graph embeddings using SDNE
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T873032_Graph_embeddings_using_Convnet_Stellargraph.html">
   Graph embeddings using Convnet Stellargraph
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T674201_Graph_embeddings.html">
   Graph ML Embeddings
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T457098_KHGT_knowledge_graph_embeddings.html">
   KHGT knowledge graph embeddings
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T403235_Contextualized_Knowledge_Graph_Embedding.html">
   Contextualized Knowledge Graph Embedding
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T643979_Learning_Node_Representations_from_Multiple_Social_Contexts.html">
   SPLITTER: Learning Node Representations from Multiple Contexts
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T874868_GAT_in_Tensorflow.x.html">
   GAT using Tensorflow
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T249662_GAT_in_PyTorch_on_CORA.html">
   GAT in PyTorch on CORA
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T336765_FB15K_Graph_Embedding_Learning_in_PyTorch_Big_Graph.html">
   FB15K Graph Embedding Learning in PyTorch Big Graph
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T012114_SAGEConv_graph_embeddings_in_PyG.html">
   SAGEConv graph embeddings in PyG
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="_sources/T384270_DeepWalk_in_python.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/sparsh-ai/graph-embeddings/main?urlpath=lab/tree/docs/T384270_DeepWalk_in_python.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        <a class="colab-button" href="https://colab.research.google.com/github/sparsh-ai/graph-embeddings/blob/main/docs/T384270_DeepWalk_in_python.ipynb"><button type="button" class="btn btn-secondary topbarbtn"
                title="Launch Colab" data-toggle="tooltip" data-placement="left"><img class="colab-button-logo"
                    src="_static/images/logo_colab.png"
                    alt="Interact on Colab">Colab</button></a>
        
        <button type="button" class="btn btn-secondary topbarbtn"
            onclick="initThebeSBT()" title="Launch Thebe" data-toggle="tooltip" data-placement="left"><i
                class="fas fa-play"></i><span style="margin-left: .4em;">Live Code</span></button>
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#imports">
   Imports
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#deepwalk">
   Deepwalk
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#hierarchical-softmax">
   Hierarchical Softmax
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#plots">
   Plots
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="deepwalk-in-python">
<h1>DeepWalk in python<a class="headerlink" href="#deepwalk-in-python" title="Permalink to this headline">¶</a></h1>
<div class="section" id="imports">
<h2>Imports<a class="headerlink" href="#imports" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span> 
<span class="kn">from</span> <span class="nn">gensim.models</span> <span class="kn">import</span> <span class="n">Word2Vec</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">ABC</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="deepwalk">
<h2>Deepwalk<a class="headerlink" href="#deepwalk" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">DeepWalk</span><span class="p">:</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Implement DeepWalk algorithm.</span>
<span class="sd">  reference paper : DeepWalk: Online Learning of Social Representations</span>
<span class="sd">  link : https://arxiv.org/abs/1403.6652</span>
<span class="sd">  Using the algorithm can get graph embedding model with your network data.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">G</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">adjlist_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">edgelist_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parameters</span>
<span class="sd">    G : networkx : networkx graph.</span>
<span class="sd">    </span>
<span class="sd">    adjlist_path : network file path. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">G</span> <span class="o">==</span> <span class="n">adjlist_path</span> <span class="o">==</span> <span class="n">edgelist_path</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;all parameter is None, please check your input.&#39;</span><span class="p">)</span>
      
    <span class="k">try</span><span class="p">:</span>
      
      <span class="k">if</span> <span class="n">G</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">G</span> <span class="o">=</span> <span class="n">G</span>
      <span class="k">elif</span> <span class="n">adjlist_path</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">read_adjlist</span><span class="p">(</span><span class="n">adjlist_path</span><span class="p">)</span>
      <span class="k">elif</span> <span class="n">edgelist_path</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">read_edgelist</span><span class="p">(</span><span class="n">edgelist_path</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
      <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>


  <span class="k">def</span> <span class="nf">random_walk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterations</span><span class="p">,</span> <span class="n">start_node</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">random_walk_times</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    : Implement of random walk algorithm :</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------------------------------------</span>
<span class="sd">    iterations : int : random walk number of iteration </span>
<span class="sd">    start_node : str : choose start node (random choose a node, if start_node is None)</span>
<span class="sd">    random_walk_times : int : random walk times.</span>
<span class="sd">    ----------------------------------------</span>
<span class="sd">    Returns</span>
<span class="sd">    walk_records : list of walks record</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">walk_records</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iterations</span><span class="p">):</span>
      
      <span class="k">if</span> <span class="n">start_node</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">s_node</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">()))</span>
        <span class="n">walk_path</span> <span class="o">=</span> <span class="p">[</span><span class="n">s_node</span><span class="p">]</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">walk_path</span> <span class="o">=</span> <span class="p">[</span><span class="n">start_node</span><span class="p">]</span>
        
      <span class="n">current_node</span> <span class="o">=</span> <span class="n">s_node</span>
      <span class="k">while</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">walk_path</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">random_walk_times</span><span class="p">):</span>
        <span class="n">neighbors</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">current_node</span><span class="p">))</span>
        
        
        <span class="n">current_node</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">neighbors</span><span class="p">)</span>
        <span class="n">walk_path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_node</span><span class="p">)</span>
          
      <span class="n">walk_records</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">walk_path</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">walk_records</span>

  <span class="k">def</span> <span class="nf">buildWord2Vec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    </span>
<span class="sd">    Using gensim to build word2vec model</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------------------------------------</span>
<span class="sd">    **kwargs</span>
<span class="sd">    </span>
<span class="sd">    walk_path : list : random walk results</span>
<span class="sd">    size : int : specific embedding dimension, default : 100 dim</span>
<span class="sd">    window : int : specific learn context window size, default : 5</span>
<span class="sd">    workers : int : specific workers. default : 2</span>
<span class="sd">    ----------------------------------------</span>
<span class="sd">    Returns</span>
<span class="sd">    walk_records : list of walks record</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">walk_path</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;walk_path&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">walk_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="k">return</span> 
    
    <span class="n">size</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;size&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">window</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;window&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">workers</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;workers&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="n">embedding_model</span> <span class="o">=</span> <span class="n">Word2Vec</span><span class="p">(</span><span class="n">walk_path</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">,</span> <span class="n">min_count</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">workers</span><span class="o">=</span><span class="n">workers</span><span class="p">,</span> <span class="n">sg</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">hs</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">embedding_model</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="hierarchical-softmax">
<h2>Hierarchical Softmax<a class="headerlink" href="#hierarchical-softmax" title="Permalink to this headline">¶</a></h2>
<p>First, we’ll build the components required to use hierarchical softmax. From the paper:</p>
<p>Computing the partition function (normalization factor) is expensive. If we assign the vertices to the leaves of a binary tree, the prediction problem turns into maximizing the probability of a specific path in the tree</p>
<p>Thus, instead of having a classifier that predicts probabilities for each word from our vocabulary (besides the one we’re currently iterating on), we can structure the loss function as a binary tree where every internal node contains its own binary classifier. Computing the loss (and gradient) can therefore be done in <span class="math notranslate nohighlight">\(O(logv)\)</span> predictions rather than <span class="math notranslate nohighlight">\(O(v)\)</span> (as is the case with <span class="math notranslate nohighlight">\(v\)</span> labels), where <span class="math notranslate nohighlight">\(v\)</span> is the number of vertices in our graph.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Tree</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span> 
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">merge</span><span class="p">(</span><span class="n">dims</span><span class="p">,</span> <span class="n">lr</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">left</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">left</span><span class="o">.</span><span class="n">set_left</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">right</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">right</span><span class="o">.</span><span class="n">set_right</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">InternalNode</span><span class="p">(</span><span class="n">dims</span><span class="p">,</span> <span class="n">lr</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">)</span>
    
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">build_tree</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="n">dims</span><span class="p">,</span> <span class="n">lr</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">nodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">Tree</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">dims</span><span class="p">,</span> <span class="n">lr</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">nodes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">nodes</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        
    <span class="k">def</span> <span class="nf">set_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">t</span>
        
    <span class="k">def</span> <span class="nf">set_left</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_right</span> <span class="o">=</span> <span class="kc">False</span>
        
    <span class="k">def</span> <span class="nf">set_right</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_right</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">InternalNode</span><span class="p">(</span><span class="n">Tree</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dims</span><span class="p">,</span> <span class="n">lr</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">is_right</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dims</span> <span class="o">=</span> <span class="n">dims</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_left_child</span><span class="p">(</span><span class="n">left</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_right_child</span><span class="p">(</span><span class="n">right</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_parent</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_right</span> <span class="o">=</span> <span class="n">is_right</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">gradients</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lr</span> <span class="o">=</span> <span class="n">lr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="o">=</span> <span class="n">batch_size</span>
        
    <span class="k">def</span> <span class="nf">set_left_child</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">child</span><span class="p">:</span> <span class="n">Tree</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">left</span> <span class="o">=</span> <span class="n">child</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">left</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">left</span><span class="o">.</span><span class="n">set_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">left</span><span class="o">.</span><span class="n">set_left</span><span class="p">()</span>
            
    <span class="k">def</span> <span class="nf">set_right_child</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">child</span><span class="p">:</span> <span class="n">Tree</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">right</span> <span class="o">=</span> <span class="n">child</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">right</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">right</span><span class="o">.</span><span class="n">set_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">right</span><span class="o">.</span><span class="n">set_right</span><span class="p">()</span>
            
    <span class="k">def</span> <span class="nf">set_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">:</span> <span class="n">Tree</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>    
        
    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">embedding</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">embedding</span><span class="p">)</span> <span class="k">if</span> <span class="n">right</span> <span class="k">else</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">embedding</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">d</span><span class="p">))</span>
    
    <span class="k">def</span> <span class="nf">update_gradients</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gradient</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gradients</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gradient</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gradients</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">:</span>
            <span class="n">avg_gradient</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gradients</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">lr</span> <span class="o">*</span> <span class="n">avg_gradient</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gradients</span> <span class="o">=</span> <span class="p">[]</span>
        
    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dims</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">dims</span> <span class="ow">and</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">left</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">left</span> <span class="ow">and</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">right</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">right</span> <span class="ow">and</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lr</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">lr</span> <span class="ow">and</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">batch_size</span>
        <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Leaf</span><span class="p">(</span><span class="n">Tree</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vertex</span><span class="p">,</span> <span class="n">parent</span><span class="p">:</span> <span class="n">InternalNode</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">is_right</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_right</span> <span class="o">=</span> <span class="n">is_right</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">vertex</span> <span class="o">=</span> <span class="n">vertex</span>
        
    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">anchor_vertex</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">gradients</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">total_cost</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">emb_grads</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="n">node</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">is_right</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">is_right</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">parent</span>        
            <span class="n">prob</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">anchor_vertex</span><span class="o">.</span><span class="n">embedding</span><span class="p">,</span> <span class="n">is_right</span><span class="p">)</span>
            <span class="n">log_prob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">prob</span><span class="p">)</span>
            <span class="n">total_cost</span> <span class="o">-=</span> <span class="n">log_prob</span>
            <span class="n">u</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">prob</span>
            <span class="n">node</span><span class="o">.</span><span class="n">update_gradients</span><span class="p">(</span><span class="n">u</span><span class="o">*</span><span class="n">anchor_vertex</span><span class="o">.</span><span class="n">embedding</span><span class="p">)</span>
            <span class="n">emb_grads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">u</span><span class="o">*</span><span class="n">node</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
        <span class="n">anchor_vertex</span><span class="o">.</span><span class="n">update_embedding</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">emb_grads</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">total_cost</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Vertex</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">lr</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">=</span> <span class="n">dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">dim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lr</span> <span class="o">=</span> <span class="n">lr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gradients</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
        
    <span class="k">def</span> <span class="nf">update_embedding</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gradient</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">):</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">gradients</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gradient</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gradients</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">:</span>
            <span class="n">avg_gradient</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gradients</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">lr</span> <span class="o">*</span> <span class="n">avg_gradient</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gradients</span> <span class="o">=</span> <span class="p">[]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">v</span> <span class="o">=</span> <span class="n">Vertex</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mf">1e-1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">v2</span> <span class="o">=</span> <span class="n">Vertex</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mf">1e-1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">leaf</span> <span class="o">=</span> <span class="n">Leaf</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
<span class="n">leaf2</span> <span class="o">=</span> <span class="n">Leaf</span><span class="p">(</span><span class="n">v2</span><span class="p">)</span>
<span class="n">i</span> <span class="o">=</span> <span class="n">InternalNode</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mf">1e-1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">leaf</span><span class="p">,</span> <span class="n">leaf2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">before</span> <span class="o">=</span> <span class="n">leaf2</span><span class="o">.</span><span class="n">vertex</span><span class="o">.</span><span class="n">embedding</span>
<span class="n">before_parent</span> <span class="o">=</span> <span class="n">leaf</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">params</span>
<span class="nb">print</span><span class="p">(</span><span class="n">before</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[0.70466282 0.4704185  0.15045063 0.93010221 0.04333254 0.33917607
 0.3072665  0.97709016]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">leaf</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">leaf2</span><span class="o">.</span><span class="n">vertex</span><span class="p">)</span>
<span class="n">after</span> <span class="o">=</span> <span class="n">leaf2</span><span class="o">.</span><span class="n">vertex</span><span class="o">.</span><span class="n">embedding</span>
<span class="n">after_parent</span> <span class="o">=</span> <span class="n">leaf</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">params</span>
<span class="nb">print</span><span class="p">(</span><span class="n">after</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[0.70405907 0.45365486 0.08264726 0.91088379 0.01787853 0.27183648
 0.26271421 0.96241706]
</pre></div>
</div>
</div>
</div>
<p>Leaves 1 and 2 should share parent i. Also, each should have its own vertex (v and v2 respectively).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">leaf</span><span class="o">.</span><span class="n">vertex</span> <span class="o">==</span> <span class="n">v</span>
<span class="k">assert</span> <span class="n">leaf</span><span class="o">.</span><span class="n">vertex</span> <span class="o">!=</span> <span class="n">v2</span>
<span class="k">assert</span> <span class="n">leaf2</span><span class="o">.</span><span class="n">vertex</span> <span class="o">==</span> <span class="n">v2</span>
<span class="k">assert</span> <span class="n">leaf2</span><span class="o">.</span><span class="n">vertex</span> <span class="o">!=</span> <span class="n">v</span>
<span class="k">assert</span> <span class="n">leaf</span><span class="o">.</span><span class="n">parent</span> <span class="o">==</span> <span class="n">i</span>
<span class="k">assert</span> <span class="n">leaf2</span><span class="o">.</span><span class="n">parent</span> <span class="o">==</span> <span class="n">i</span>
</pre></div>
</div>
</div>
</div>
<p>As a convenience method, we have Tree.merge which should do the same thing as the manual passing to the InternalNode constructor above.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">i2</span> <span class="o">=</span> <span class="n">Tree</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mf">1e-1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">leaf</span><span class="p">,</span> <span class="n">leaf2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">i2</span> <span class="o">==</span> <span class="n">i</span>
</pre></div>
</div>
</div>
</div>
<p>We should be able to create an internal node with a single child.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">i3</span> <span class="o">=</span> <span class="n">InternalNode</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">leaf</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">i3</span><span class="o">.</span><span class="n">left</span> <span class="o">==</span> <span class="n">leaf</span>
<span class="k">assert</span> <span class="n">i3</span><span class="o">.</span><span class="n">right</span> <span class="ow">is</span> <span class="kc">None</span>
</pre></div>
</div>
</div>
</div>
<p>We should be able to combine two internal nodes under a third internal node.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">two_internal_nodes</span> <span class="o">=</span> <span class="n">Tree</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">i2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">two_internal_nodes</span><span class="o">.</span><span class="n">left</span> <span class="o">==</span> <span class="n">i</span>
<span class="k">assert</span> <span class="n">two_internal_nodes</span><span class="o">.</span><span class="n">right</span> <span class="o">==</span> <span class="n">i2</span>
<span class="k">assert</span> <span class="n">i</span><span class="o">.</span><span class="n">parent</span> <span class="o">==</span> <span class="n">two_internal_nodes</span>
<span class="k">assert</span> <span class="n">i2</span><span class="o">.</span><span class="n">parent</span> <span class="o">==</span> <span class="n">two_internal_nodes</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">p</span> <span class="o">=</span> <span class="n">Tree</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mf">1e-1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">leaf</span><span class="p">,</span> <span class="n">leaf2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">leaf</span><span class="o">.</span><span class="n">parent</span> <span class="o">==</span> <span class="n">leaf2</span><span class="o">.</span><span class="n">parent</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">leaf</span><span class="o">.</span><span class="n">vertex</span><span class="o">.</span><span class="n">embedding</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([0.14202065, 0.94789345, 0.96777175, 0.12845376, 0.33301731,
       0.25128948, 0.98405048, 0.66509886])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">before</span> <span class="o">=</span> <span class="n">leaf2</span><span class="o">.</span><span class="n">vertex</span><span class="o">.</span><span class="n">embedding</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">before_parent</span> <span class="o">=</span> <span class="n">leaf</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">leaf</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">leaf2</span><span class="o">.</span><span class="n">vertex</span><span class="p">)</span>
<span class="n">after</span> <span class="o">=</span> <span class="n">leaf2</span><span class="o">.</span><span class="n">vertex</span><span class="o">.</span><span class="n">embedding</span>
<span class="n">after_parent</span> <span class="o">=</span> <span class="n">leaf</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">params</span>
<span class="p">(</span><span class="n">before</span><span class="p">,</span> <span class="n">after</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(array([0.70405907, 0.45365486, 0.08264726, 0.91088379, 0.01787853,
        0.27183648, 0.26271421, 0.96241706]),
 array([ 0.66127081,  0.45437708,  0.00473115,  0.84110065, -0.02988149,
         0.22792929,  0.2618126 ,  0.92318361]))
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">before_parent</span><span class="p">,</span> <span class="n">after_parent</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(array([0.55046806, 0.03145724, 0.89740018, 0.87697905, 0.54720746,
        0.52541901, 0.03329589, 0.53246957]),
 array([ 0.48884187, -0.00825111,  0.89016608,  0.79724952,  0.54564255,
         0.5016252 ,  0.01030055,  0.44822934]))
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">leaf</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">leaf2</span><span class="o">.</span><span class="n">vertex</span><span class="o">.</span><span class="n">embedding</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">+</span> <span class="n">leaf</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">leaf2</span><span class="o">.</span><span class="n">vertex</span><span class="o">.</span><span class="n">embedding</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">leaf</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">leaf2</span><span class="o">.</span><span class="n">vertex</span><span class="o">.</span><span class="n">embedding</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.8188850193603718
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">new_leaf</span> <span class="o">=</span> <span class="n">Leaf</span><span class="p">(</span><span class="n">Vertex</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">new_leaf2</span> <span class="o">=</span> <span class="n">Leaf</span><span class="p">(</span><span class="n">Vertex</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">merged</span> <span class="o">=</span> <span class="n">Tree</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">new_leaf</span><span class="p">,</span> <span class="n">new_leaf2</span><span class="p">)</span>
<span class="n">before1</span> <span class="o">=</span> <span class="n">new_leaf2</span><span class="o">.</span><span class="n">vertex</span><span class="o">.</span><span class="n">embedding</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">new_leaf</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new_leaf2</span><span class="o">.</span><span class="n">vertex</span><span class="p">)</span>
<span class="n">after1</span> <span class="o">=</span> <span class="n">new_leaf2</span><span class="o">.</span><span class="n">vertex</span><span class="o">.</span><span class="n">embedding</span>
<span class="p">(</span><span class="n">before1</span><span class="p">,</span> <span class="n">after1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(array([0.93594794, 0.00617317, 0.83736121, 0.53829744, 0.86273901,
        0.25883039, 0.64857575, 0.48665158]),
 array([ 0.92966094, -0.00183856,  0.83637281,  0.52932184,  0.85800988,
         0.25527446,  0.64106637,  0.47856129]))
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">before2</span> <span class="o">=</span> <span class="n">new_leaf</span><span class="o">.</span><span class="n">vertex</span><span class="o">.</span><span class="n">embedding</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">new_leaf2</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new_leaf</span><span class="o">.</span><span class="n">vertex</span><span class="p">)</span>
<span class="n">after2</span> <span class="o">=</span> <span class="n">new_leaf</span><span class="o">.</span><span class="n">vertex</span><span class="o">.</span><span class="n">embedding</span>
<span class="p">(</span><span class="n">before2</span><span class="p">,</span> <span class="n">after2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(array([0.01577104, 0.73203528, 0.51886159, 0.03187183, 0.52233666,
        0.12200931, 0.67895869, 0.06495115]),
 array([0.01467268, 0.73063752, 0.51869031, 0.03030379, 0.52151184,
        0.12138838, 0.67764856, 0.06353787]))
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">emb_length</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">lr</span> <span class="o">=</span> <span class="mf">1e-3</span>
<span class="n">bs</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">v1</span> <span class="o">=</span> <span class="n">Vertex</span><span class="p">(</span><span class="n">emb_length</span><span class="p">,</span> <span class="n">lr</span><span class="p">,</span> <span class="n">bs</span><span class="p">)</span>
<span class="n">v2</span> <span class="o">=</span> <span class="n">Vertex</span><span class="p">(</span><span class="n">emb_length</span><span class="p">,</span> <span class="n">lr</span><span class="p">,</span> <span class="n">bs</span><span class="p">)</span>
<span class="n">v3</span> <span class="o">=</span> <span class="n">Vertex</span><span class="p">(</span><span class="n">emb_length</span><span class="p">,</span> <span class="n">lr</span><span class="p">,</span> <span class="n">bs</span><span class="p">)</span>
<span class="n">random_walk</span> <span class="o">=</span> <span class="p">[</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">,</span> <span class="n">v3</span><span class="p">]</span>
<span class="n">leaves</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">Leaf</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">random_walk</span><span class="p">))</span>
<span class="n">tree</span> <span class="o">=</span> <span class="n">Tree</span><span class="o">.</span><span class="n">build_tree</span><span class="p">(</span><span class="n">leaves</span><span class="p">,</span> <span class="n">emb_length</span><span class="p">,</span> <span class="n">lr</span><span class="p">,</span> <span class="n">bs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">leaves</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&lt;__main__.Leaf at 0x7fc68b836d50&gt;,
 &lt;__main__.Leaf at 0x7fc68b836a90&gt;,
 &lt;__main__.Leaf at 0x7fc68b836250&gt;,
 None]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tree</span><span class="o">.</span><span class="vm">__class__</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>__main__.InternalNode
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">v1</span><span class="o">.</span><span class="n">embedding</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">v2</span><span class="o">.</span><span class="n">embedding</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">v3</span><span class="o">.</span><span class="n">embedding</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>((10,), (10,), (10,))
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">leaf1</span><span class="p">,</span> <span class="n">leaf2</span><span class="p">,</span> <span class="n">leaf3</span><span class="p">,</span> <span class="n">empty_leaf</span> <span class="o">=</span> <span class="n">leaves</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">leaf3</span><span class="o">.</span><span class="n">vertex</span><span class="o">.</span><span class="n">embedding</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([0.56054777, 0.8018071 , 0.99571521, 0.35924211, 0.63936966,
       0.31256406, 0.49017507, 0.63942332, 0.55382691, 0.59270016])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">leaf1</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">leaf2</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">leaf3</span><span class="o">.</span><span class="n">parent</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&lt;__main__.InternalNode at 0x7fc68b836610&gt;,
 &lt;__main__.InternalNode at 0x7fc68b836610&gt;,
 &lt;__main__.InternalNode at 0x7fc68b8360d0&gt;)
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="plots">
<h2>Plots<a class="headerlink" href="#plots" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">costs1</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">costs3</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">combined_cost</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10000</span><span class="p">):</span>
    <span class="n">cost1</span> <span class="o">=</span> <span class="n">leaf1</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">leaf2</span><span class="o">.</span><span class="n">vertex</span><span class="p">)</span>
    <span class="n">cost3</span> <span class="o">=</span> <span class="n">leaf3</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">leaf2</span><span class="o">.</span><span class="n">vertex</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="n">bs</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">costs1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost1</span><span class="p">)</span> 
        <span class="n">costs3</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost3</span><span class="p">)</span>
        <span class="n">combined_cost</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost1</span><span class="o">+</span><span class="n">cost3</span><span class="p">)</span> 
    
<span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">costs1</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;line&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.axes._subplots.AxesSubplot at 0x7fc68b78efd0&gt;
</pre></div>
</div>
<img alt="_images/T384270_DeepWalk_in_python_40_1.png" src="_images/T384270_DeepWalk_in_python_40_1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">costs3</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;line&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.axes._subplots.AxesSubplot at 0x7fc68b693dd0&gt;
</pre></div>
</div>
<img alt="_images/T384270_DeepWalk_in_python_41_1.png" src="_images/T384270_DeepWalk_in_python_41_1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">combined_cost</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;line&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.axes._subplots.AxesSubplot at 0x7fc6921dd190&gt;
</pre></div>
</div>
<img alt="_images/T384270_DeepWalk_in_python_42_1.png" src="_images/T384270_DeepWalk_in_python_42_1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">emb_length</span><span class="p">,</span> <span class="n">lr</span><span class="p">,</span> <span class="n">bs</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="mf">1e-4</span><span class="p">,</span> <span class="mi">100</span>
<span class="n">leaves</span> <span class="o">=</span> <span class="p">[</span><span class="n">Vertex</span><span class="p">(</span><span class="n">emb_length</span><span class="p">,</span> <span class="n">lr</span><span class="p">,</span> <span class="n">bs</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">)]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">leaves</span> <span class="o">=</span> <span class="p">[</span><span class="n">Leaf</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">leaves</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tree</span> <span class="o">=</span> <span class="n">Tree</span><span class="o">.</span><span class="n">build_tree</span><span class="p">(</span><span class="n">leaves</span><span class="p">,</span> <span class="n">emb_length</span><span class="p">,</span> <span class="n">lr</span><span class="p">,</span> <span class="n">bs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">chosen_leaf</span> <span class="o">=</span> <span class="n">leaves</span><span class="p">[</span><span class="mi">20</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#slow</span>
<span class="n">costs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">num_iter</span> <span class="o">=</span> <span class="mi">3000</span>
<span class="n">epoch_costs</span> <span class="o">=</span> <span class="p">[]</span> 
<span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_iter</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">20</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">costs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">leaves</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">chosen_leaf</span><span class="o">.</span><span class="n">vertex</span><span class="p">))</span> 
    <span class="n">epoch_costs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">costs</span><span class="p">))</span>
    <span class="n">costs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">epoch_costs</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;line&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.axes._subplots.AxesSubplot at 0x7fc68b6a80d0&gt;
</pre></div>
</div>
<img alt="_images/T384270_DeepWalk_in_python_47_1.png" src="_images/T384270_DeepWalk_in_python_47_1.png" />
</div>
</div>
<p>This is an interesting result – it seems a little unusual that we would see training loss going up, but some things to consider:</p>
<ul class="simple">
<li><p>In the “real” version, the leaf embeddings are (hopefully) going to have some relationship with the internal node model parameters. In this toy version, we’ve uniformly initialized all parameters and then trained the model on every single leaf for many iterations. It’s basically learning how to optimize random noise.</p></li>
<li><p>We’re using plain vanilla batch GD here, with no learning rate annealing (or any of the wide number of GD enhancements that exist). It’s very possible that we’re getting gradient explosions / divergence towards the end here.</p></li>
</ul>
<p>The goal of hierarchical softmax is to make the scoring function run in <span class="math notranslate nohighlight">\(O(logv)\)</span> rather than <span class="math notranslate nohighlight">\(O(v)\)</span> by organizing the nodes as a binary tree with a binary classifier at each internal node. At a high level, we follow these steps:</p>
<ol class="simple">
<li><p>We identify a leaf that is contained within the window of our vertex within the current random walk</p></li>
<li><p>We take that leaf’s parent and compute the probability of having followed the correct path (left or right) to the leaf we identified in step 1 by using the model parameters for this internal node combined with the features for the current vertex (which is a row in <span class="math notranslate nohighlight">\(\Phi\)</span>).</p></li>
<li><p>We repeat step 2 for all internal nodes until we get to the root</p></li>
<li><p>The product of all of the internal probabilities gives us the probability of seeing a co-occurrence of the neighbor node given what we know about the node we’re exploring</p></li>
<li><p><span class="math notranslate nohighlight">\(-logPr(u_k|\Phi(v_j))\)</span> is our loss function, where <span class="math notranslate nohighlight">\(Pr(u_k|\Phi(v_j))\)</span> is the probability we calculated in step 4</p></li>
<li><p>We use the loss in step 5 to perform a gradient descent step updating both the parameters of our model and <span class="math notranslate nohighlight">\(\Phi(v_j)\)</span>:</p></li>
</ol>
<div class="math notranslate nohighlight">
\[\theta \leftarrow \theta - \alpha_\theta * \frac{\partial J}{\partial \theta}\]</div>
<br>
$$\Phi \leftarrow \Phi - \alpha_\Phi * \frac{\partial J}{\partial \Phi}$$
<p>Where <span class="math notranslate nohighlight">\(\theta\)</span> represents all of the parameters of all of the models in the internal nodes of the tree, and <span class="math notranslate nohighlight">\(\Phi\)</span> represents the latent representation of the current vertex.</p>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "sparsh-ai/graph-embeddings",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
            



<div class='prev-next-bottom'>
    
    <div id="prev">
        <a class="left-prev" href="T984528_Graph_encoder.html" title="previous page">
            <i class="prevnext-label fas fa-angle-left"></i>
            <div class="prevnext-info">
                <p class="prevnext-label">previous</p>
                <p class="prevnext-title">Graph encoder</p>
            </div>
        </a>
    </div>
     <div id="next">
        <a class="right-next" href="T382881_DeepWalk_on_Karateclub.html" title="next page">
            <div class="prevnext-info">
                <p class="prevnext-label">next</p>
                <p class="prevnext-title">DeepWalk on Karateclub</p>
            </div>
            <i class="prevnext-label fas fa-angle-right"></i>
        </a>
     </div>

</div>
        
        </div>
    </div>
    <footer class="footer">
    <div class="container">
      <p>
        
          By Sparsh A.<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>